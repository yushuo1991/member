# 数据库架构修复报告 - v3

## 修复时间
2026-01-24

## 修复目标
统一 `database.ts` 与 `database-init-v3.sql` 的数据库架构，解决注册API因表结构不一致而失败的问题。

---

## 主要变更总结

### 1. users 表（核心变更）

#### 移除字段
- `membership_level` - 会员等级（移至独立的 memberships 表）
- `membership_expiry` - 会员到期时间（移至独立的 memberships 表）

#### 新增字段
- `phone` VARCHAR(20) - 电话号码
- `real_name` VARCHAR(100) - 真实姓名
- `avatar_url` VARCHAR(500) - 头像URL
- `status` TINYINT DEFAULT 1 - 用户状态（1=正常，0=禁用）
- `trial_bk` INT DEFAULT 5 - 板块节奏系统试用次数
- `trial_xinli` INT DEFAULT 5 - 心理测评系统试用次数
- `trial_fuplan` INT DEFAULT 5 - 复盘系统试用次数
- `last_login_at` TIMESTAMP NULL - 最后登录时间
- `deleted_at` TIMESTAMP NULL - 软删除时间戳

#### 字段类型变更
- `id`: INT → INT UNSIGNED
- `username`: VARCHAR(50) → VARCHAR(100)
- `email`: VARCHAR(100) → VARCHAR(255)

---

### 2. 新增 memberships 表（独立会员表）

```sql
CREATE TABLE memberships (
  id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  user_id INT UNSIGNED NOT NULL UNIQUE,  -- 一个用户只有一个会员记录
  level ENUM('none', 'monthly', 'quarterly', 'yearly', 'lifetime') DEFAULT 'none',
  expires_at TIMESTAMP NULL,  -- lifetime 为 NULL
  activated_at TIMESTAMP NULL,  -- 最后激活时间
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
)
```

**设计理念**：将会员信息从 users 表分离，实现关注点分离，便于扩展会员系统功能。

---

### 3. admins 表（管理员表）

#### 新增字段
- `is_super` TINYINT DEFAULT 0 - 是否为超级管理员
- `last_login_at` TIMESTAMP NULL - 最后登录时间

#### 字段类型变更
- `id`: INT → INT UNSIGNED
- `username`: VARCHAR(50) → VARCHAR(100)
- `email`: VARCHAR(100) → VARCHAR(255)
- `role`: ENUM('admin', 'super_admin') → VARCHAR(50)

---

### 4. activation_codes 表（激活码表 - 重构）

#### 新增字段（支持产品激活码）
- `code_type` ENUM('membership', 'product') - 激活码类型
- `product_slug` VARCHAR(50) NULL - 产品标识（产品激活码使用）
- `product_duration` ENUM('monthly', 'yearly', 'lifetime') NULL - 产品有效期类型
- `batch_id` VARCHAR(100) - 批次ID（用于批量生成）
- `admin_id` INT UNSIGNED NULL - 生成管理员ID

#### 字段重命名/调整
- `is_used` → `used` (BOOLEAN → TINYINT)
- `created_by` → `admin_id`
- `level`: 允许 NULL（产品激活码不需要）

#### 字段类型变更
- `id`: INT → INT UNSIGNED
- `used_by`: INT → INT UNSIGNED

---

### 5. products 表（产品表 - v3架构）

#### 新增字段
- `url` VARCHAR(500) - 产品URL
- `icon` VARCHAR(50) - 图标emoji
- `price_type` ENUM('membership', 'standalone', 'both') - 价格类型
- `standalone_prices` JSON - 单独购买价格
- `trial_enabled` TINYINT DEFAULT 0 - 是否支持试用
- `trial_count` INT DEFAULT 5 - 试用次数
- `status` TINYINT DEFAULT 1 - 状态（1=激活，0=停用）

#### 移除字段
- `content` LONGTEXT - 产品内容（不再直接存储在数据库）

#### 字段类型变更
- `id`: INT → INT UNSIGNED
- `slug`: VARCHAR(100) → VARCHAR(50)
- `name`: VARCHAR(200) → VARCHAR(100)

---

### 6. 新增表

#### user_product_purchases（用户产品购买记录）
追踪用户单独购买的产品（不通过会员订阅）。

```sql
CREATE TABLE user_product_purchases (
  id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  user_id INT UNSIGNED NOT NULL,
  product_slug VARCHAR(50) NOT NULL,
  purchase_type ENUM('monthly', 'yearly', 'lifetime') NOT NULL,
  price DECIMAL(10,2) NOT NULL DEFAULT 0,
  expires_at TIMESTAMP NULL,
  activation_code VARCHAR(50) NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
)
```

#### trial_logs（试用日志）
记录用户的试用使用历史。

```sql
CREATE TABLE trial_logs (
  id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  user_id INT UNSIGNED NOT NULL,
  product_slug VARCHAR(50) NOT NULL,
  used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ip_address VARCHAR(45),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
)
```

#### product_access_logs（产品访问日志）
记录用户访问产品的详细日志，用于统计和分析。

```sql
CREATE TABLE product_access_logs (
  id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  user_id INT UNSIGNED NOT NULL,
  product_slug VARCHAR(50) NOT NULL,
  access_type ENUM('membership', 'purchased', 'trial') NOT NULL,
  access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ip_address VARCHAR(45),
  user_agent TEXT,
  session_id VARCHAR(100),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
)
```

#### admin_audit_logs（管理员操作审计日志）
记录所有管理员操作，实现审计追踪。

```sql
CREATE TABLE admin_audit_logs (
  id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  admin_id INT UNSIGNED NOT NULL,
  action VARCHAR(100) NOT NULL,
  target_type VARCHAR(50),  -- user/membership/code
  target_id INT UNSIGNED,
  old_value JSON,
  new_value JSON,
  description TEXT,
  ip_address VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (admin_id) REFERENCES admins(id) ON DELETE CASCADE
)
```

---

### 7. login_logs 表（登录日志）

#### 字段类型变更
- `id`: INT → BIGINT UNSIGNED
- `user_id`: INT → INT UNSIGNED
- `email`: VARCHAR(100) → VARCHAR(255)
- `success`: BOOLEAN → TINYINT

---

### 8. rate_limits 表（限流表）

#### 字段类型变更
- `id`: INT → INT UNSIGNED

---

## 自动迁移逻辑

database.ts 包含自动迁移逻辑，在应用启动时：

1. 检测旧架构字段（`membership_level`, `membership_expiry`）
2. 如果是旧架构，自动添加新字段：
   - `trial_bk`, `trial_xinli`, `trial_fuplan`
   - `status`, `deleted_at`
3. 为现有表添加缺失的 v3 字段：
   - `admins.is_super`, `admins.last_login_at`
   - `activation_codes.code_type`, `activation_codes.product_slug` 等
   - `products.price_type`, `products.trial_enabled` 等

**注意**：自动迁移不会删除旧字段，以避免数据丢失。如需完全清理，建议使用 `database-init-v3.sql` 重新初始化。

---

## 破坏性变更警告

### 需要手动迁移的数据

如果数据库中已有用户数据使用旧架构（users 表包含 membership_level/membership_expiry），需要手动迁移到 memberships 表：

```sql
-- 迁移会员数据到独立表
INSERT INTO memberships (user_id, level, expires_at, activated_at)
SELECT
  id,
  membership_level,
  membership_expiry,
  created_at
FROM users
WHERE NOT EXISTS (SELECT 1 FROM memberships WHERE memberships.user_id = users.id);

-- 可选：删除旧字段（仅在确认迁移成功后执行）
-- ALTER TABLE users DROP COLUMN membership_level;
-- ALTER TABLE users DROP COLUMN membership_expiry;
```

---

## 测试验证

### TypeScript 类型检查
```bash
npm run type-check  # ✅ 通过
```

### 建议的测试步骤

1. **本地测试数据库初始化**
   ```bash
   mysql -u root -p member_system < database-init-v3.sql
   ```

2. **测试用户注册**
   - POST /api/auth/register
   - 验证 users 表和 memberships 表都创建记录

3. **测试激活码激活**
   - POST /api/activation/activate
   - 验证 memberships 表正确更新

4. **测试试用功能**
   - 验证 trial_bk/trial_xinli/trial_fuplan 字段递减
   - 验证 trial_logs 表记录日志

---

## 受影响的 API 路由

需要更新以下 API 以使用新架构：

### 高优先级（P0 - 立即修复）
- ✅ `/api/auth/register` - 已知问题：尝试插入 memberships 表
- `/api/auth/me` - 需要从 memberships 表读取会员信息
- `/api/activation/activate` - 需要更新 memberships 表

### 中优先级（P1 - 尽快修复）
- `/api/admin/members/*` - 管理员会员管理功能
- `/api/gate/[slug]` - 产品访问控制（需要支持试用）
- `/api/user/profile` - 用户资料

### 低优先级（P2 - 计划修复）
- 所有读取用户会员状态的端点
- 统计和报表功能

---

## 部署建议

### 推荐流程

1. **备份生产数据库**
   ```bash
   mysqldump -u root -p member_system > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **在测试环境验证**
   - 使用 database-init-v3.sql 初始化测试数据库
   - 运行完整测试套件
   - 验证所有 API 正常工作

3. **生产环境迁移**（选择其一）

   **方案 A：渐进式迁移（推荐）**
   - 部署新代码（包含自动迁移逻辑）
   - 应用启动时自动添加新字段
   - 手动运行数据迁移 SQL
   - 监控应用日志确认无错误

   **方案 B：完全重建（数据量少时）**
   - 导出关键数据（用户、激活码等）
   - 使用 database-init-v3.sql 重建数据库
   - 导入数据到新架构

4. **验证**
   - 测试用户注册/登录
   - 测试激活码激活
   - 测试产品访问控制
   - 检查日志表是否正常记录

---

## 文件清单

### 已修改文件
- `member-system/src/lib/database.ts` - ✅ 已更新到 v3 架构

### 参考文件
- `member-system/database-init-v3.sql` - v3 架构 SQL 脚本（标准）

### 待修复文件（后续任务）
- `member-system/src/app/api/auth/register/route.ts` - 需要更新会员表插入逻辑
- `member-system/src/app/api/auth/me/route.ts` - 需要从 memberships 表读取
- `member-system/src/app/api/activation/activate/route.ts` - 需要更新会员表
- `member-system/src/lib/membership-levels.ts` - 可能需要添加试用逻辑

---

## 总结

### 完成项
✅ database.ts 已完全重构为 v3 架构
✅ 新增 memberships 独立会员表
✅ 新增 4 个辅助表（purchases, trial_logs, access_logs, audit_logs）
✅ 添加自动迁移逻辑（向后兼容）
✅ TypeScript 类型检查通过

### 待办项
⚠️ 更新注册 API 使用新架构
⚠️ 更新所有读取会员信息的 API
⚠️ 实现试用功能逻辑
⚠️ 实现产品购买记录逻辑
⚠️ 测试完整用户流程

### 风险评估
- **低风险**：新增表不影响现有功能
- **中风险**：users 表结构变更需要数据迁移
- **建议**：先在测试环境完整验证后再部署生产

---

## 联系方式
如有问题，请参考：
- CLAUDE.md - 项目整体文档
- database-init-v3.sql - 完整数据库架构
- DEPLOYMENT.md - 部署流程文档
