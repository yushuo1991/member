name: Check PM2 Logs

on:
  workflow_dispatch:
    inputs:
      restart_app:
        description: 'Restart the application to clear cache'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  check-logs:
    runs-on: ubuntu-latest
    steps:
      - name: Check server status and optionally restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            echo "=== PM2 Status ==="
            pm2 list
            echo ""

            echo "=== PM2 Process Details (member-web) ==="
            pm2 describe member-web | grep -E "(cwd|script|exec_cwd|pm_cwd)" || echo "Cannot get process details"
            echo ""

            echo "=== Check all image files with MD5 ==="
            echo "--- member-system path ---"
            cd /www/wwwroot/member-system/public/products/ 2>/dev/null && md5sum *.png 2>/dev/null || echo "No files"
            echo ""
            echo "--- member-monorepo path ---"
            cd /www/wwwroot/member-monorepo/apps/web/public/products/ 2>/dev/null && md5sum *.png 2>/dev/null || echo "No files"
            echo ""

            # Restart app if requested to clear cache
            if [ "${{ github.event.inputs.restart_app }}" == "true" ]; then
              echo "=== Restarting application to clear cache ==="

              # Clear Next.js cache in BOTH paths
              rm -rf /www/wwwroot/member-system/.next/cache 2>/dev/null || true
              rm -rf /www/wwwroot/member-monorepo/apps/web/.next/cache 2>/dev/null || true
              echo "Cleared .next/cache in both paths"

              # Restart PM2 process
              pm2 restart member-web
              echo "Restarted member-web"

              sleep 5
              echo ""
              echo "=== PM2 Status after restart ==="
              pm2 list
            fi

            echo ""
            echo "=== Test each image file via HTTP ==="
            for img in xuexiquan-cover bankuaizhushou-cover bk-cover xinli-cover fuplan-cover qingxubiaoge-cover fupanbanmian-cover jiandanfupan-cover; do
              echo "--- $img.png ---"
              curl -sI "http://127.0.0.1:3000/products/$img.png" | grep -E "(HTTP|Content-Length|Last-Modified)"
            done
            echo ""

            echo "=== Check which path the app uses ==="
            curl -sI http://127.0.0.1:3000/products/xuexiquan-cover.png | grep -E "(Content-Length|Last-Modified)"
