name: è‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨

on:
  push:
    branches:
      - main  # å½“æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯Secretsé…ç½®
        run: |
          echo "========================================="
          echo "éªŒè¯GitHub Secretsé…ç½®"
          echo "========================================="
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "âŒ SERVER_HOST æœªé…ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "âŒ SERVER_USER æœªé…ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "âŒ SERVER_SSH_KEY æœªé…ç½®"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰Secretså·²é…ç½®"
          echo "HOST: ${{ secrets.SERVER_HOST }}"
          echo "USER: ${{ secrets.SERVER_USER }}"
          echo ""

      - name: é€šè¿‡SSHéƒ¨ç½²ä»£ç åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            echo "========================================="
            echo "å¼€å§‹è‡ªåŠ¨éƒ¨ç½² Member System"
            echo "æ—¶é—´: $(date)"
            echo "========================================="

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/member-system

            # æ˜¾ç¤ºå½“å‰åˆ†æ”¯å’Œç‰ˆæœ¬
            echo "ğŸ“Œ å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            echo "ğŸ“Œ å½“å‰ç‰ˆæœ¬: $(git rev-parse --short HEAD)"

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ­£åœ¨æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main

            # æ˜¾ç¤ºæ›´æ–°åçš„ç‰ˆæœ¬
            echo "ğŸ“Œ æ›´æ–°åç‰ˆæœ¬: $(git rev-parse --short HEAD)"
            echo "ğŸ“Œ æœ€æ–°æäº¤: $(git log -1 --pretty=format:'%h - %s (%an, %ar)')"

            # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®åº“è¿ç§»æ–‡ä»¶
            if [ -f "database-init-v2.1-FIXED.sql" ]; then
              echo ""
              echo "========================================="
              echo "ğŸ—„ï¸  æ£€æµ‹åˆ°æ•°æ®åº“è¿ç§»æ–‡ä»¶"
              echo "========================================="

              # å¤‡ä»½ç°æœ‰æ•°æ®åº“
              echo "ğŸ’¾ å¤‡ä»½å½“å‰æ•°æ®åº“..."
              mysqldump -u root -p${{ secrets.DB_PASSWORD }} member_system > /root/backup_$(date +%Y%m%d_%H%M%S).sql

              # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºç¼ºå¤±çš„è¡¨
              echo "ğŸ” æ£€æŸ¥è¡¨ç»“æ„..."
              TABLES_MISSING=0

              # æ£€æŸ¥ memberships è¡¨
              if ! mysql -u root -p${{ secrets.DB_PASSWORD }} member_system -e "DESCRIBE memberships" &>/dev/null; then
                echo "âš ï¸  memberships è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
                TABLES_MISSING=1
              else
                echo "âœ… memberships è¡¨å·²å­˜åœ¨"
              fi

              # æ£€æŸ¥ rate_limits è¡¨
              if ! mysql -u root -p${{ secrets.DB_PASSWORD }} member_system -e "DESCRIBE rate_limits" &>/dev/null; then
                echo "âš ï¸  rate_limits è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
                TABLES_MISSING=1
              else
                echo "âœ… rate_limits è¡¨å·²å­˜åœ¨"
              fi

              # å¦‚æœæœ‰ç¼ºå¤±çš„è¡¨ï¼Œæ‰§è¡Œè¿ç§»
              if [ $TABLES_MISSING -eq 1 ]; then
                echo ""
                echo "ğŸ”§ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
                mysql -u root -p${{ secrets.DB_PASSWORD }} < database-init-v2.1-FIXED.sql

                echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
                echo ""
                echo "ğŸ“Š å½“å‰è¡¨ç»“æ„:"
                mysql -u root -p${{ secrets.DB_PASSWORD }} member_system -e "SHOW TABLES;"
              else
                echo "âœ… æ‰€æœ‰å¿…éœ€çš„è¡¨éƒ½å·²å­˜åœ¨ï¼Œè·³è¿‡è¿ç§»"
              fi

              echo "========================================="
            fi

            # å®‰è£…ä¾èµ–
            echo ""
            echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–..."
            npm install --production

            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ æ­£åœ¨æ„å»ºé¡¹ç›®..."
            npm run build

            # é‡å¯PM2æœåŠ¡
            echo "ğŸ”„ æ­£åœ¨é‡å¯æœåŠ¡..."
            pm2 restart member-system || pm2 start npm --name "member-system" -- start

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 3

            # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
            echo ""
            echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
            pm2 list

            # æµ‹è¯•APIç«¯ç‚¹
            echo ""
            echo "ğŸ§ª æµ‹è¯•APIç«¯ç‚¹..."

            # æµ‹è¯•æ³¨å†Œç«¯ç‚¹
            REGISTER_TEST=$(curl -s -X POST http://localhost:3000/api/auth/register \
              -H "Content-Type: application/json" \
              -d '{"username":"healthcheck_'$(date +%s)'","email":"health'$(date +%s)'@test.com","password":"Test123456"}' \
              -w "\n%{http_code}")

            HTTP_CODE=$(echo "$REGISTER_TEST" | tail -n1)

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "409" ]; then
              echo "âœ… æ³¨å†Œç«¯ç‚¹æ­£å¸¸ (HTTP $HTTP_CODE)"
            else
              echo "âš ï¸  æ³¨å†Œç«¯ç‚¹è¿”å› HTTP $HTTP_CODE"
              echo "å“åº”: $(echo "$REGISTER_TEST" | head -n-1)"
            fi

            echo ""
            echo "========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: http://8.153.110.212"
            echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
            echo "========================================="

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ æœåŠ¡å™¨: 8.153.110.212"
          echo "ğŸ“¦ é¡¹ç›®å·²è‡ªåŠ¨æ›´æ–°å¹¶é‡å¯"
          echo "ğŸ—„ï¸  æ•°æ®åº“å·²è‡ªåŠ¨è¿ç§»"

      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "ğŸ” è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—"
          echo "ğŸ“‹ å¸¸è§é—®é¢˜:"
          echo "  1. æ£€æŸ¥ GitHub Secrets æ˜¯å¦æ­£ç¡®é…ç½®"
          echo "  2. æ£€æŸ¥æœåŠ¡å™¨SSHå¯†é’¥æ˜¯å¦æœ‰æ•ˆ"
          echo "  3. æ£€æŸ¥æ•°æ®åº“å¯†ç æ˜¯å¦æ­£ç¡®"
