name: Deploy Monorepo (Turborepo + Multi-App)

on:
  push:
    branches: [main, master]
    paths:
      - "apps/**"
      - "packages/**"
      - "turbo.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/deploy-monorepo.yml"
  workflow_dispatch:
    inputs:
      apps:
        description: 'Apps to deploy (comma-separated: web,bk,fuplan,xinli or "all")'
        required: false
        default: 'all'

concurrency:
  group: deploy-monorepo-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: 8.15.0
  NODE_VERSION: 18.19.0

jobs:
  # æ£€æµ‹å“ªäº›åº”ç”¨éœ€è¦éƒ¨ç½²
  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      bk: ${{ steps.filter.outputs.bk }}
      fuplan: ${{ steps.filter.outputs.fuplan }}
      xinli: ${{ steps.filter.outputs.xinli }}
      packages: ${{ steps.filter.outputs.packages }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
              - 'turbo.json'
            bk:
              - 'apps/bk/**'
              - 'packages/**'
              - 'turbo.json'
            fuplan:
              - 'apps/fuplan/**'
              - 'packages/**'
              - 'turbo.json'
            xinli:
              - 'apps/xinli/**'
              - 'packages/**'
              - 'turbo.json'
            packages:
              - 'packages/**'

  # å¹¶è¡Œæ„å»ºæ‰€æœ‰åº”ç”¨
  build:
    name: Build Apps (Turborepo)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.web == 'true' ||
      needs.detect-changes.outputs.bk == 'true' ||
      needs.detect-changes.outputs.fuplan == 'true' ||
      needs.detect-changes.outputs.xinli == 'true' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all apps with Turbo
        run: |
          # åªæ„å»ºéœ€è¦éƒ¨ç½²çš„åº”ç”¨
          if [ "${{ needs.detect-changes.outputs.web }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"web"* ]]; then
            echo "ğŸ”¨ Building web app..."
            pnpm turbo run build --filter=web --force
          fi

          if [ "${{ needs.detect-changes.outputs.bk }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"bk"* ]]; then
            echo "ğŸ”¨ Building bk app..."
            pnpm turbo run build --filter=bk
          fi

          if [ "${{ needs.detect-changes.outputs.fuplan }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"fuplan"* ]]; then
            echo "ğŸ”¨ Building fuplan app..."
            pnpm turbo run build --filter=fuplan
          fi

          if [ "${{ needs.detect-changes.outputs.xinli }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"xinli"* ]]; then
            echo "ğŸ”¨ Building xinli app..."
            pnpm turbo run build --filter=xinli
          fi
        env:
          NODE_ENV: production

      - name: Prepare deployment artifacts
        run: |
          mkdir -p deployment-artifacts

          echo "ğŸ“¦ Packaging deployment artifacts..."

          # æ‰“åŒ…æ¯ä¸ªåº”ç”¨çš„æ„å»ºäº§ç‰©
          cd apps

          # Webåº”ç”¨ - ä½¿ç”¨-hè§£å¼•ç”¨pnpmç¬¦å·é“¾æ¥
          if [ -d "web/.next" ]; then
            echo "ğŸ“¦ Packaging web app..."
            cd web
            tar -czh -f ../../deployment-artifacts/web-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              ecosystem.config.js \
              database-init-v3.sql \
              scripts 2>/dev/null || true
            cd ..
          fi

          # BKåº”ç”¨
          if [ -d "bk/.next" ]; then
            echo "ğŸ“¦ Packaging bk app..."
            cd bk
            tar -czf ../../deployment-artifacts/bk-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              scripts 2>/dev/null || true
            cd ..
          fi

          # Fuplanåº”ç”¨
          if [ -d "fuplan/.next" ]; then
            echo "ğŸ“¦ Packaging fuplan app..."
            cd fuplan
            tar -czf ../../deployment-artifacts/fuplan-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              scripts 2>/dev/null || true
            cd ..
          fi

          # Xinliåº”ç”¨
          if [ -d "xinli/.next" ]; then
            echo "ğŸ“¦ Packaging xinli app..."
            cd xinli
            tar -czf ../../deployment-artifacts/xinli-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              scripts 2>/dev/null || true
            cd ..
          fi

          cd ..
          echo "âœ… Packaging complete"
          ls -lh deployment-artifacts/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: deployment-artifacts/*.tar.gz
          retention-days: 7

  # éƒ¨ç½²Webåº”ç”¨(ä¼šå‘˜ç³»ç»Ÿ)
  deploy-web:
    name: Deploy Web App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.web == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'web')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/web-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart web app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/member-system"
            APP_NAME="member-web"

            echo "ğŸš€ Deploying Web App (Member System)..."

            # å¤‡ä»½.env
            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.web.backup
            fi

            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p "$DEPLOY_PATH"

            # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            # è§£å‹æ„å»ºäº§ç‰©
            cd "$DEPLOY_PATH"
            tar -xzf /tmp/web-build.tar.gz

            # è°ƒè¯•ï¼šæŸ¥çœ‹è§£å‹åçš„å†…å®¹
            echo "ğŸ“‚ è§£å‹åçš„ç›®å½•å†…å®¹ï¼š"
            ls -la
            echo "ğŸ“‚ æ£€æŸ¥.next/standaloneç›®å½•ï¼š"
            ls -la .next/standalone/ 2>/dev/null || echo ".next/standaloneç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ“‚ æ£€æŸ¥.next/standalone/node_modulesç›®å½•ï¼š"
            ls -la .next/standalone/node_modules/ 2>/dev/null || echo "node_modulesä¸å­˜åœ¨"
            echo "ğŸ“‚ æ£€æŸ¥nextæ¨¡å—æ˜¯å¦å­˜åœ¨ï¼š"
            ls -la .next/standalone/node_modules/next/ 2>/dev/null || echo "nextæ¨¡å—ä¸å­˜åœ¨"
            echo "ğŸ“‚ æ£€æŸ¥.next/standalone/.nextç›®å½•ï¼š"
            ls -la .next/standalone/.next/ 2>/dev/null || echo ".nextå­ç›®å½•ä¸å­˜åœ¨"

            # æ¢å¤.env
            if [ -f /tmp/.env.web.backup ]; then
              cp /tmp/.env.web.backup .env
            fi

            # å¤åˆ¶standaloneæ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
            if [ -d ".next/standalone" ]; then
              echo "âœ… æ‰¾åˆ°standaloneç›®å½•"

              # æ£€æŸ¥æ˜¯å¦æ˜¯monorepoç»“æ„ï¼ˆæœ‰appså­ç›®å½•ï¼‰
              if [ -d ".next/standalone/apps/web" ]; then
                echo "ğŸ“‚ æ£€æµ‹åˆ°monorepoç»“æ„ï¼Œä¿æŒç›®å½•ç»“æ„ä¸å˜"

                # å¤åˆ¶.envåˆ°standaloneæ ¹ç›®å½•
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # å¤åˆ¶staticç›®å½•åˆ°æ­£ç¡®ä½ç½®
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/web/.next
                  cp -r .next/static .next/standalone/apps/web/.next/static
                fi

                echo "âœ… å‡†å¤‡å®Œæˆï¼Œå°†ä».next/standalone/apps/web/server.jså¯åŠ¨"
                SERVER_PATH=".next/standalone/apps/web/server.js"
              else
                echo "ğŸ“‚ æ£€æµ‹åˆ°æ ‡å‡†ç»“æ„ï¼Œä¿æŒstandaloneç›®å½•ä¸å˜"

                # å¤åˆ¶.envåˆ°standaloneæ ¹ç›®å½•
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # å¤åˆ¶staticç›®å½•åˆ°standalone
                if [ -d ".next/static" ]; then
                  cp -r .next/static .next/standalone/.next/static
                fi

                # å¤åˆ¶publicç›®å½•åˆ°standalone
                if [ -d "public" ]; then
                  cp -r public .next/standalone/public
                fi

                echo "âœ… å‡†å¤‡å®Œæˆï¼Œå°†ä».next/standalone/server.jså¯åŠ¨"
                SERVER_PATH=".next/standalone/server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "âŒ $SERVER_PATH ä¸å­˜åœ¨"
            else
              echo "âŒ .next/standaloneç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi

            # æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœè¿ç§»è„šæœ¬å­˜åœ¨ï¼‰
            if [ -f "scripts/migrate-add-trial-support.js" ]; then
              echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
              if [ -f ".env" ]; then
                export $(cat .env | grep -E '^(DB_HOST|DB_USER|DB_PASSWORD|DB_NAME)=' | xargs)
              fi
              node scripts/migrate-add-trial-support.js || echo "âš ï¸ æ•°æ®åº“è¿ç§»å¤±è´¥æˆ–å·²æ‰§è¡Œè¿‡"
            fi

            # PM2é‡å¯
            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"
            pm2 start $SERVER_PATH --name $APP_NAME
            pm2 save

            # æ¸…ç†
            rm -f /tmp/web-build.tar.gz

            echo "âœ… Web app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # ç­‰å¾…åº”ç”¨å¯åŠ¨å¹¶æ£€æŸ¥æ—¥å¿—
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 5
            echo "ğŸ“‹ æ£€æŸ¥åº”ç”¨çŠ¶æ€å’Œæ—¥å¿—..."
            pm2 status
            echo "ğŸ“‹ æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "ğŸ“‹ é”™è¯¯æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # éƒ¨ç½²BKåº”ç”¨(æ¿å—èŠ‚å¥ç³»ç»Ÿ)
  deploy-bk:
    name: Deploy BK App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.bk == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'bk')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/bk-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart bk app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/bk-system"
            APP_NAME="member-bk"

            echo "ğŸš€ Deploying BK App (Board Rhythm System)..."

            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.bk.backup
            fi

            mkdir -p "$DEPLOY_PATH"

            # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            cd "$DEPLOY_PATH"
            tar -xzf /tmp/bk-build.tar.gz

            # è°ƒè¯•ï¼šæŸ¥çœ‹è§£å‹åçš„å†…å®¹
            echo "ğŸ“‚ è§£å‹åçš„ç›®å½•å†…å®¹ï¼š"
            ls -la
            echo "ğŸ“‚ æ£€æŸ¥.nextç›®å½•ï¼š"
            ls -la .next/ 2>/dev/null || echo ".nextç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ“‚ æ£€æŸ¥.next/standaloneç›®å½•ï¼š"
            ls -la .next/standalone/ 2>/dev/null || echo ".next/standaloneç›®å½•ä¸å­˜åœ¨"

            if [ -f /tmp/.env.bk.backup ]; then
              cp /tmp/.env.bk.backup .env
            fi

            # å¤åˆ¶standaloneæ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
            if [ -d ".next/standalone" ]; then
              echo "âœ… æ‰¾åˆ°standaloneç›®å½•"

              # æ£€æŸ¥æ˜¯å¦æ˜¯monorepoç»“æ„ï¼ˆæœ‰appså­ç›®å½•ï¼‰
              if [ -d ".next/standalone/apps/bk" ]; then
                echo "ğŸ“‚ æ£€æµ‹åˆ°monorepoç»“æ„ï¼Œä¿æŒç›®å½•ç»“æ„ä¸å˜"

                # å¤åˆ¶.envåˆ°standaloneæ ¹ç›®å½•ï¼ˆä¾›æ‰€æœ‰åº”ç”¨å…±äº«ï¼‰
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # å¤åˆ¶staticç›®å½•åˆ°æ­£ç¡®ä½ç½®
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/bk/.next
                  cp -r .next/static .next/standalone/apps/bk/.next/static
                fi

                echo "âœ… å‡†å¤‡å®Œæˆï¼Œå°†ä».next/standalone/apps/bk/server.jså¯åŠ¨"
                SERVER_PATH=".next/standalone/apps/bk/server.js"
              else
                echo "ğŸ“‚ æ£€æµ‹åˆ°æ ‡å‡†ç»“æ„ï¼Œç›´æ¥å¤åˆ¶"
                # å…ˆå¤‡ä»½staticç›®å½•
                if [ -d ".next/static" ]; then
                  cp -r .next/static /tmp/static-backup-bk
                fi

                # å…ˆå¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•é¿å…å†²çª
                rm -rf /tmp/standalone-temp-bk
                cp -r .next/standalone /tmp/standalone-temp-bk

                # æ¸…ç†å½“å‰ç›®å½•çš„æ—§æ–‡ä»¶ï¼ˆä¿ç•™.envå’Œ.gitï¼‰
                find . -maxdepth 1 ! -name '.' ! -name '..' ! -name '.env' ! -name '.git' ! -name 'logs' -exec rm -rf {} + 2>/dev/null || true

                # ä»ä¸´æ—¶ç›®å½•å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
                cp -r /tmp/standalone-temp-bk/* .

                # æ¢å¤staticç›®å½•
                if [ -d "/tmp/static-backup-bk" ]; then
                  mkdir -p .next
                  cp -r /tmp/static-backup-bk .next/static
                  rm -rf /tmp/static-backup-bk
                fi

                rm -rf /tmp/standalone-temp-bk
                echo "âœ… å¤åˆ¶å®Œæˆ"
                SERVER_PATH="server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "âŒ $SERVER_PATH ä¸å­˜åœ¨"
            fi

            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"
            PORT=3001 pm2 start $SERVER_PATH --name $APP_NAME
            pm2 save

            rm -f /tmp/bk-build.tar.gz

            echo "âœ… BK app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # ç­‰å¾…åº”ç”¨å¯åŠ¨å¹¶æ£€æŸ¥æ—¥å¿—
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 5
            echo "ğŸ“‹ æ£€æŸ¥åº”ç”¨çŠ¶æ€å’Œæ—¥å¿—..."
            pm2 status
            echo "ğŸ“‹ æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "ğŸ“‹ é”™è¯¯æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # éƒ¨ç½²Fuplanåº”ç”¨(å¤ç›˜ç³»ç»Ÿ)
  deploy-fuplan:
    name: Deploy Fuplan App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.fuplan == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'fuplan')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/fuplan-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart fuplan app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/fuplan-system"
            APP_NAME="member-fuplan"

            echo "ğŸš€ Deploying Fuplan App (Review System)..."

            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.fuplan.backup
            fi

            mkdir -p "$DEPLOY_PATH"

            # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            cd "$DEPLOY_PATH"
            tar -xzf /tmp/fuplan-build.tar.gz

            if [ -f /tmp/.env.fuplan.backup ]; then
              cp /tmp/.env.fuplan.backup .env
            fi

            # å¤åˆ¶standaloneæ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
            if [ -d ".next/standalone" ]; then
              echo "âœ… æ‰¾åˆ°standaloneç›®å½•"

              # æ£€æŸ¥æ˜¯å¦æ˜¯monorepoç»“æ„ï¼ˆæœ‰appså­ç›®å½•ï¼‰
              if [ -d ".next/standalone/apps/fuplan" ]; then
                echo "ğŸ“‚ æ£€æµ‹åˆ°monorepoç»“æ„ï¼Œä¿æŒç›®å½•ç»“æ„ä¸å˜"

                # å¤åˆ¶.envåˆ°standaloneæ ¹ç›®å½•
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # å¤åˆ¶staticç›®å½•åˆ°æ­£ç¡®ä½ç½®
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/fuplan/.next
                  cp -r .next/static .next/standalone/apps/fuplan/.next/static
                fi

                echo "âœ… å‡†å¤‡å®Œæˆï¼Œå°†ä».next/standalone/apps/fuplan/server.jså¯åŠ¨"
                SERVER_PATH=".next/standalone/apps/fuplan/server.js"
              else
                echo "ğŸ“‚ æ£€æµ‹åˆ°æ ‡å‡†ç»“æ„ï¼Œç›´æ¥å¤åˆ¶"
                if [ -d ".next/static" ]; then
                  cp -r .next/static /tmp/static-backup-fuplan
                fi

                rm -rf /tmp/standalone-temp-fuplan
                cp -r .next/standalone /tmp/standalone-temp-fuplan

                find . -maxdepth 1 ! -name '.' ! -name '..' ! -name '.env' ! -name '.git' ! -name 'logs' -exec rm -rf {} + 2>/dev/null || true

                cp -r /tmp/standalone-temp-fuplan/* .

                if [ -d "/tmp/static-backup-fuplan" ]; then
                  mkdir -p .next
                  cp -r /tmp/static-backup-fuplan .next/static
                  rm -rf /tmp/static-backup-fuplan
                fi

                rm -rf /tmp/standalone-temp-fuplan
                echo "âœ… å¤åˆ¶å®Œæˆ"
                SERVER_PATH="server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "âŒ $SERVER_PATH ä¸å­˜åœ¨"
            fi

            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"
            PORT=3002 pm2 start $SERVER_PATH --name $APP_NAME
            pm2 save

            rm -f /tmp/fuplan-build.tar.gz

            echo "âœ… Fuplan app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # ç­‰å¾…åº”ç”¨å¯åŠ¨å¹¶æ£€æŸ¥æ—¥å¿—
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 5
            echo "ğŸ“‹ æ£€æŸ¥åº”ç”¨çŠ¶æ€å’Œæ—¥å¿—..."
            pm2 status
            echo "ğŸ“‹ æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "ğŸ“‹ é”™è¯¯æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # éƒ¨ç½²Xinliåº”ç”¨(å¿ƒç†æµ‹è¯„ç³»ç»Ÿ)
  deploy-xinli:
    name: Deploy Xinli App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.xinli == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'xinli')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/xinli-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart xinli app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/xinli-system"
            APP_NAME="member-xinli"

            echo "ğŸš€ Deploying Xinli App (Psychology System)..."

            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.xinli.backup
            fi

            mkdir -p "$DEPLOY_PATH"

            # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            cd "$DEPLOY_PATH"
            tar -xzf /tmp/xinli-build.tar.gz

            if [ -f /tmp/.env.xinli.backup ]; then
              cp /tmp/.env.xinli.backup .env
            fi

            # å¤åˆ¶standaloneæ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
            if [ -d ".next/standalone" ]; then
              echo "âœ… æ‰¾åˆ°standaloneç›®å½•"

              # æ£€æŸ¥æ˜¯å¦æ˜¯monorepoç»“æ„ï¼ˆæœ‰appså­ç›®å½•ï¼‰
              if [ -d ".next/standalone/apps/xinli" ]; then
                echo "ğŸ“‚ æ£€æµ‹åˆ°monorepoç»“æ„ï¼Œä¿æŒç›®å½•ç»“æ„ä¸å˜"

                # å¤åˆ¶.envåˆ°standaloneæ ¹ç›®å½•
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # å¤åˆ¶staticç›®å½•åˆ°æ­£ç¡®ä½ç½®
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/xinli/.next
                  cp -r .next/static .next/standalone/apps/xinli/.next/static
                fi

                echo "âœ… å‡†å¤‡å®Œæˆï¼Œå°†ä».next/standalone/apps/xinli/server.jså¯åŠ¨"
                SERVER_PATH=".next/standalone/apps/xinli/server.js"
              else
                echo "ğŸ“‚ æ£€æµ‹åˆ°æ ‡å‡†ç»“æ„ï¼Œç›´æ¥å¤åˆ¶"
                if [ -d ".next/static" ]; then
                  cp -r .next/static /tmp/static-backup-xinli
                fi

                rm -rf /tmp/standalone-temp-xinli
                cp -r .next/standalone /tmp/standalone-temp-xinli

                find . -maxdepth 1 ! -name '.' ! -name '..' ! -name '.env' ! -name '.git' ! -name 'logs' -exec rm -rf {} + 2>/dev/null || true

                cp -r /tmp/standalone-temp-xinli/* .

                if [ -d "/tmp/static-backup-xinli" ]; then
                  mkdir -p .next
                  cp -r /tmp/static-backup-xinli .next/static
                  rm -rf /tmp/static-backup-xinli
                fi

                rm -rf /tmp/standalone-temp-xinli
                echo "âœ… å¤åˆ¶å®Œæˆ"
                SERVER_PATH="server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "âŒ $SERVER_PATH ä¸å­˜åœ¨"
            fi

            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"
            PORT=3003 pm2 start $SERVER_PATH --name $APP_NAME
            pm2 save

            rm -f /tmp/xinli-build.tar.gz

            echo "âœ… Xinli app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # ç­‰å¾…åº”ç”¨å¯åŠ¨å¹¶æ£€æŸ¥æ—¥å¿—
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 5
            echo "ğŸ“‹ æ£€æŸ¥åº”ç”¨çŠ¶æ€å’Œæ—¥å¿—..."
            pm2 status
            echo "ğŸ“‹ æœ€è¿‘çš„åº”ç”¨æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "ğŸ“‹ é”™è¯¯æ—¥å¿—ï¼š"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # éƒ¨ç½²åå¥åº·æ£€æŸ¥
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-bk, deploy-fuplan, deploy-xinli]
    if: always() && (needs.deploy-web.result == 'success' || needs.deploy-bk.result == 'success' || needs.deploy-fuplan.result == 'success' || needs.deploy-xinli.result == 'success')

    steps:
      - name: Check deployed apps
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ“Š Application Status:"
            echo "===================="
            pm2 list

            echo ""
            echo "ğŸ” Health Checks:"
            echo "===================="

            # Web App (Port 3000)
            if pm2 describe member-web > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3000 > /dev/null 2>&1 && echo "âœ… Web App: Healthy" || echo "âŒ Web App: Failed"
            fi

            # BK App (Port 3001)
            if pm2 describe member-bk > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3001 > /dev/null 2>&1 && echo "âœ… BK App: Healthy" || echo "âŒ BK App: Failed"
            fi

            # Fuplan App (Port 3002)
            if pm2 describe member-fuplan > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3002 > /dev/null 2>&1 && echo "âœ… Fuplan App: Healthy" || echo "âŒ Fuplan App: Failed"
            fi

            # Xinli App (Port 3003)
            if pm2 describe member-xinli > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3003 > /dev/null 2>&1 && echo "âœ… Xinli App: Healthy" || echo "âŒ Xinli App: Failed"
            fi

            echo ""
            echo "âœ… Deployment completed!"
