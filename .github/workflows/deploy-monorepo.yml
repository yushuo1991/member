name: Deploy Monorepo (Turborepo + Multi-App)

on:
  push:
    branches: [main, master]
    paths:
      - "apps/**"
      - "packages/**"
      - "turbo.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/deploy-monorepo.yml"
  workflow_dispatch:
    inputs:
      apps:
        description: 'Apps to deploy (comma-separated: web,bk,fuplan,xinli or "all")'
        required: false
        default: 'all'

concurrency:
  group: deploy-monorepo-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: 8.15.0
  NODE_VERSION: 18.19.0

jobs:
  # Ê£ÄÊµãÂì™‰∫õÂ∫îÁî®ÈúÄË¶ÅÈÉ®ÁΩ≤
  detect-changes:
    name: Detect Changed Apps
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      bk: ${{ steps.filter.outputs.bk }}
      fuplan: ${{ steps.filter.outputs.fuplan }}
      xinli: ${{ steps.filter.outputs.xinli }}
      packages: ${{ steps.filter.outputs.packages }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
              - 'turbo.json'
            bk:
              - 'apps/bk/**'
              - 'packages/**'
              - 'turbo.json'
            fuplan:
              - 'apps/fuplan/**'
              - 'packages/**'
              - 'turbo.json'
            xinli:
              - 'apps/xinli/**'
              - 'packages/**'
              - 'turbo.json'
            packages:
              - 'packages/**'

  # Âπ∂Ë°åÊûÑÂª∫ÊâÄÊúâÂ∫îÁî®
  build:
    name: Build Apps (Turborepo)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.web == 'true' ||
      needs.detect-changes.outputs.bk == 'true' ||
      needs.detect-changes.outputs.fuplan == 'true' ||
      needs.detect-changes.outputs.xinli == 'true' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all apps with Turbo
        run: |
          # Âè™ÊûÑÂª∫ÈúÄË¶ÅÈÉ®ÁΩ≤ÁöÑÂ∫îÁî®
          if [ "${{ needs.detect-changes.outputs.web }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"web"* ]]; then
            echo "üî® Building web app..."
            pnpm turbo run build --filter=web --force
          fi

          if [ "${{ needs.detect-changes.outputs.bk }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"bk"* ]]; then
            echo "üî® Building bk app..."
            pnpm turbo run build --filter=bk
          fi

          if [ "${{ needs.detect-changes.outputs.fuplan }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"fuplan"* ]]; then
            echo "üî® Building fuplan app..."
            pnpm turbo run build --filter=fuplan
          fi

          if [ "${{ needs.detect-changes.outputs.xinli }}" == "true" ] || [ "${{ github.event.inputs.apps }}" == "all" ] || [[ "${{ github.event.inputs.apps }}" == *"xinli"* ]]; then
            echo "üî® Building xinli app..."
            pnpm turbo run build --filter=xinli
          fi
        env:
          NODE_ENV: production

      - name: Prepare deployment artifacts
        run: |
          mkdir -p deployment-artifacts

          echo "üì¶ Packaging deployment artifacts..."

          # ÊâìÂåÖÊØè‰∏™Â∫îÁî®ÁöÑÊûÑÂª∫‰∫ßÁâ©
          cd apps

          # WebÂ∫îÁî®
          if [ -d "web/.next" ]; then
            echo "üì¶ Packaging web app..."
            cd web
            tar -czf ../../deployment-artifacts/web-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              ecosystem.config.js \
              database-init-v3.sql \
              scripts 2>/dev/null || true
            cd ..
          fi

          # BKÂ∫îÁî®
          if [ -d "bk/.next" ]; then
            echo "üì¶ Packaging bk app..."
            cd bk
            tar -czf ../../deployment-artifacts/bk-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              scripts 2>/dev/null || true
            cd ..
          fi

          # FuplanÂ∫îÁî®
          if [ -d "fuplan/.next" ]; then
            echo "üì¶ Packaging fuplan app..."
            cd fuplan
            tar -czf ../../deployment-artifacts/fuplan-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              scripts 2>/dev/null || true
            cd ..
          fi

          # XinliÂ∫îÁî®
          if [ -d "xinli/.next" ]; then
            echo "üì¶ Packaging xinli app..."
            cd xinli
            tar -czf ../../deployment-artifacts/xinli-build.tar.gz \
              .next/standalone \
              .next/static \
              public \
              package.json \
              pnpm-lock.yaml \
              next.config.js \
              scripts 2>/dev/null || true
            cd ..
          fi

          cd ..
          echo "‚úÖ Packaging complete"
          ls -lh deployment-artifacts/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: deployment-artifacts/*.tar.gz
          retention-days: 7

  # ÈÉ®ÁΩ≤WebÂ∫îÁî®(‰ºöÂëòÁ≥ªÁªü)
  deploy-web:
    name: Deploy Web App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.web == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'web')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/web-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart web app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/member-system"
            APP_NAME="member-web"

            echo "üöÄ Deploying Web App (Member System)..."

            # Â§á‰ªΩ.env
            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.web.backup
            fi

            # ÂàõÂª∫ÈÉ®ÁΩ≤ÁõÆÂΩï
            mkdir -p "$DEPLOY_PATH"

            # Ê∏ÖÁêÜÊóßÁöÑÊûÑÂª∫‰∫ßÁâ©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            # Ëß£ÂéãÊûÑÂª∫‰∫ßÁâ©
            cd "$DEPLOY_PATH"
            tar -xzf /tmp/web-build.tar.gz

            # Ë∞ÉËØïÔºöÊü•ÁúãËß£ÂéãÂêéÁöÑÂÜÖÂÆπ
            echo "üìÇ Ëß£ÂéãÂêéÁöÑÁõÆÂΩïÂÜÖÂÆπÔºö"
            ls -la
            echo "üìÇ Ê£ÄÊü•.next/standaloneÁõÆÂΩïÔºö"
            ls -la .next/standalone/ 2>/dev/null || echo ".next/standaloneÁõÆÂΩï‰∏çÂ≠òÂú®"
            echo "üìÇ Ê£ÄÊü•.next/standalone/node_modulesÁõÆÂΩïÔºö"
            ls -la .next/standalone/node_modules/ 2>/dev/null || echo "node_modules‰∏çÂ≠òÂú®"
            echo "üìÇ Ê£ÄÊü•nextÊ®°ÂùóÊòØÂê¶Â≠òÂú®Ôºö"
            ls -la .next/standalone/node_modules/next/ 2>/dev/null || echo "nextÊ®°Âùó‰∏çÂ≠òÂú®"
            echo "üìÇ Ê£ÄÊü•.next/standalone/.nextÁõÆÂΩïÔºö"
            ls -la .next/standalone/.next/ 2>/dev/null || echo ".nextÂ≠êÁõÆÂΩï‰∏çÂ≠òÂú®"

            # ÊÅ¢Â§ç.env
            if [ -f /tmp/.env.web.backup ]; then
              cp /tmp/.env.web.backup .env
            fi

            # Â§çÂà∂standaloneÊñá‰ª∂Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
            if [ -d ".next/standalone" ]; then
              echo "‚úÖ ÊâæÂà∞standaloneÁõÆÂΩï"

              # Ê£ÄÊü•ÊòØÂê¶ÊòØmonorepoÁªìÊûÑÔºàÊúâappsÂ≠êÁõÆÂΩïÔºâ
              if [ -d ".next/standalone/apps/web" ]; then
                echo "üìÇ Ê£ÄÊµãÂà∞monorepoÁªìÊûÑÔºå‰øùÊåÅÁõÆÂΩïÁªìÊûÑ‰∏çÂèò"

                # ÂÆâË£ÖÁúüÂÆû‰æùËµñÊõøÊç¢pnpmÁ¨¶Âè∑ÈìæÊé•
                echo "üîó Installing dependencies in standalone..."
                cd .next/standalone
                rm -rf node_modules
                cp package.json package.json.bak
                printf '{"name":"s","private":true,"dependencies":{"next":"14.2.35","react":"18.3.1","react-dom":"18.3.1","mysql2":"3.11.0","bcryptjs":"2.4.3","jsonwebtoken":"9.0.2"}}' > package.json
                npm install --no-package-lock 2>&1 | tail -3
                mv package.json.bak package.json
                cd ../..
                echo "‚úÖ Dependencies installed"

                # Á°Æ‰øù.envÂåÖÂê´COOKIE_DOMAIN
                if [ -f .env ] && ! grep -q "COOKIE_DOMAIN" .env; then
                  echo '' >> .env
                  echo '# CookieÂüüÂêçÔºàÂ≠êÂüüÂêçÂÖ±‰∫´Ôºâ' >> .env
                  echo 'COOKIE_DOMAIN=.yushuofupan.com' >> .env
                fi

                # Â§çÂà∂.envÂà∞standaloneÊ†πÁõÆÂΩï
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # Â§çÂà∂staticÁõÆÂΩïÂà∞Ê≠£Á°Æ‰ΩçÁΩÆ
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/web/.next
                  cp -r .next/static .next/standalone/apps/web/.next/static
                fi

                echo "‚úÖ ÂáÜÂ§áÂÆåÊàêÔºåÂ∞Ü‰ªé.next/standalone/apps/web/server.jsÂêØÂä®"
                SERVER_PATH=".next/standalone/apps/web/server.js"
              else
                echo "üìÇ Ê£ÄÊµãÂà∞Ê†áÂáÜÁªìÊûÑÔºå‰øùÊåÅstandaloneÁõÆÂΩï‰∏çÂèò"

                # ÂÆâË£ÖÁúüÂÆû‰æùËµñÊõøÊç¢pnpmÁ¨¶Âè∑ÈìæÊé•
                echo "üîó Installing dependencies in standalone..."
                rm -rf .next/standalone/node_modules
                cd .next/standalone
                cp package.json package.json.bak
                printf '{"name":"s","private":true,"dependencies":{"next":"14.2.35","react":"18.3.1","react-dom":"18.3.1","mysql2":"3.11.0","bcryptjs":"2.4.3","jsonwebtoken":"9.0.2"}}' > package.json
                npm install --no-package-lock 2>&1 | tail -3
                mv package.json.bak package.json
                cd ../..
                echo "‚úÖ Dependencies installed"

                # Â§çÂà∂.envÂà∞standaloneÊ†πÁõÆÂΩï
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # Â§çÂà∂staticÁõÆÂΩïÂà∞standalone
                if [ -d ".next/static" ]; then
                  cp -r .next/static .next/standalone/.next/static
                fi

                # Â§çÂà∂publicÁõÆÂΩïÂà∞standalone
                if [ -d "public" ]; then
                  cp -r public .next/standalone/public
                fi

                echo "‚úÖ ÂáÜÂ§áÂÆåÊàêÔºåÂ∞Ü‰ªé.next/standalone/server.jsÂêØÂä®"
                SERVER_PATH=".next/standalone/server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "‚ùå $SERVER_PATH ‰∏çÂ≠òÂú®"
            else
              echo "‚ùå .next/standaloneÁõÆÂΩï‰∏çÂ≠òÂú®"
              exit 1
            fi

            # ÊâßË°åÊï∞ÊçÆÂ∫ìËøÅÁßªÔºàÂ¶ÇÊûúËøÅÁßªËÑöÊú¨Â≠òÂú®Ôºâ
            if [ -f "scripts/migrate-add-trial-support.js" ]; then
              echo "üîÑ ÊâßË°åÊï∞ÊçÆÂ∫ìËøÅÁßª..."
              if [ -f ".env" ]; then
                export $(cat .env | grep -E '^(DB_HOST|DB_USER|DB_PASSWORD|DB_NAME)=' | xargs)
              fi
              node scripts/migrate-add-trial-support.js || echo "‚ö†Ô∏è Êï∞ÊçÆÂ∫ìËøÅÁßªÂ§±Ë¥•ÊàñÂ∑≤ÊâßË°åËøá"
            fi

            # PM2ÈáçÂêØÔºà‰ΩøÁî®ecosystem.config.jsÂä†ËΩΩÁéØÂ¢ÉÂèòÈáèÔºâ
            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"

            # Ê£ÄÊµãserver.jsË∑ØÂæÑ
            if [ -f ".next/standalone/apps/web/server.js" ]; then
              WEB_SERVER=".next/standalone/apps/web/server.js"
            else
              WEB_SERVER=".next/standalone/server.js"
            fi

            # ÂàõÂª∫ecosystem.config.jsÔºà‰ªé.envËØªÂèñÁéØÂ¢ÉÂèòÈáèÔºâ
            cp /www/wwwroot/bk-system/ecosystem.config.js /tmp/eco-template.js 2>/dev/null || true
            cat > "$DEPLOY_PATH/ecosystem.config.js" <<'ECOSYS'
            var fs = require('fs'), path = require('path')
            var envFile = path.join(__dirname, '.env')
            var envVars = { NODE_ENV: 'production', PORT: '3000' }
            if (fs.existsSync(envFile)) {
              fs.readFileSync(envFile, 'utf8').split('\n').forEach(function(line) {
                line = line.trim()
                if (line && line[0] !== '#') {
                  var eq = line.indexOf('=')
                  if (eq > 0) {
                    var val = line.substring(eq + 1).trim()
                    if ((val[0] === '"' && val.slice(-1) === '"') || (val[0] === "'" && val.slice(-1) === "'")) val = val.slice(1, -1)
                    envVars[line.substring(0, eq).trim()] = val
                  }
                }
              })
            }
            module.exports = { apps: [{ name: 'member-web', script: process.env.WEB_SERVER_PATH || '.next/standalone/server.js', cwd: __dirname, env: envVars, autorestart: true, max_memory_restart: '200M' }] }
            ECOSYS

            WEB_SERVER_PATH="$WEB_SERVER" pm2 start "$DEPLOY_PATH/ecosystem.config.js"
            pm2 save

            # Ê∏ÖÁêÜ
            rm -f /tmp/web-build.tar.gz

            echo "‚úÖ Web app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # Á≠âÂæÖÂ∫îÁî®ÂêØÂä®Âπ∂Ê£ÄÊü•Êó•Âøó
            echo "‚è≥ Á≠âÂæÖÂ∫îÁî®ÂêØÂä®..."
            sleep 5
            echo "üìã Ê£ÄÊü•Â∫îÁî®Áä∂ÊÄÅÂíåÊó•Âøó..."
            pm2 status
            echo "üìã ÊúÄËøëÁöÑÂ∫îÁî®Êó•ÂøóÔºö"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "üìã ÈîôËØØÊó•ÂøóÔºö"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # ÈÉ®ÁΩ≤BKÂ∫îÁî®(ÊùøÂùóËäÇÂ•èÁ≥ªÁªü)
  deploy-bk:
    name: Deploy BK App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.bk == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'bk')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/bk-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart bk app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/bk-system"
            APP_NAME="member-bk"

            echo "üöÄ Deploying BK App (Board Rhythm System)..."

            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.bk.backup
            fi

            mkdir -p "$DEPLOY_PATH"

            # Ê∏ÖÁêÜÊóßÁöÑÊûÑÂª∫‰∫ßÁâ©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            cd "$DEPLOY_PATH"
            tar -xzf /tmp/bk-build.tar.gz

            # Ë∞ÉËØïÔºöÊü•ÁúãËß£ÂéãÂêéÁöÑÂÜÖÂÆπ
            echo "üìÇ Ëß£ÂéãÂêéÁöÑÁõÆÂΩïÂÜÖÂÆπÔºö"
            ls -la
            echo "üìÇ Ê£ÄÊü•.nextÁõÆÂΩïÔºö"
            ls -la .next/ 2>/dev/null || echo ".nextÁõÆÂΩï‰∏çÂ≠òÂú®"
            echo "üìÇ Ê£ÄÊü•.next/standaloneÁõÆÂΩïÔºö"
            ls -la .next/standalone/ 2>/dev/null || echo ".next/standaloneÁõÆÂΩï‰∏çÂ≠òÂú®"

            if [ -f /tmp/.env.bk.backup ]; then
              cp /tmp/.env.bk.backup .env
            fi

            # Â§çÂà∂standaloneÊñá‰ª∂Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
            if [ -d ".next/standalone" ]; then
              echo "‚úÖ ÊâæÂà∞standaloneÁõÆÂΩï"

              # Ê£ÄÊü•ÊòØÂê¶ÊòØmonorepoÁªìÊûÑÔºàÊúâappsÂ≠êÁõÆÂΩïÔºâ
              if [ -d ".next/standalone/apps/bk" ]; then
                echo "üìÇ Ê£ÄÊµãÂà∞monorepoÁªìÊûÑÔºå‰øùÊåÅÁõÆÂΩïÁªìÊûÑ‰∏çÂèò"

                # Â§çÂà∂.envÂà∞standaloneÊ†πÁõÆÂΩïÔºà‰æõÊâÄÊúâÂ∫îÁî®ÂÖ±‰∫´Ôºâ
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # Â§çÂà∂staticÁõÆÂΩïÂà∞Ê≠£Á°Æ‰ΩçÁΩÆ
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/bk/.next
                  cp -r .next/static .next/standalone/apps/bk/.next/static
                fi

                echo "‚úÖ ÂáÜÂ§áÂÆåÊàêÔºåÂ∞Ü‰ªé.next/standalone/apps/bk/server.jsÂêØÂä®"
                SERVER_PATH=".next/standalone/apps/bk/server.js"
              else
                echo "üìÇ Ê£ÄÊµãÂà∞Ê†áÂáÜÁªìÊûÑÔºåÁõ¥Êé•Â§çÂà∂"
                # ÂÖàÂ§á‰ªΩstaticÁõÆÂΩï
                if [ -d ".next/static" ]; then
                  cp -r .next/static /tmp/static-backup-bk
                fi

                # ÂÖàÂ§çÂà∂Âà∞‰∏¥Êó∂ÁõÆÂΩïÈÅøÂÖçÂÜ≤Á™Å
                rm -rf /tmp/standalone-temp-bk
                cp -r .next/standalone /tmp/standalone-temp-bk

                # Ê∏ÖÁêÜÂΩìÂâçÁõÆÂΩïÁöÑÊóßÊñá‰ª∂Ôºà‰øùÁïô.envÂíå.gitÔºâ
                find . -maxdepth 1 ! -name '.' ! -name '..' ! -name '.env' ! -name '.git' ! -name 'logs' -exec rm -rf {} + 2>/dev/null || true

                # ‰ªé‰∏¥Êó∂ÁõÆÂΩïÂ§çÂà∂ÊâÄÊúâÊñá‰ª∂
                cp -r /tmp/standalone-temp-bk/* .

                # ÊÅ¢Â§çstaticÁõÆÂΩï
                if [ -d "/tmp/static-backup-bk" ]; then
                  mkdir -p .next
                  cp -r /tmp/static-backup-bk .next/static
                  rm -rf /tmp/static-backup-bk
                fi

                rm -rf /tmp/standalone-temp-bk
                echo "‚úÖ Â§çÂà∂ÂÆåÊàê"
                SERVER_PATH="server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "‚ùå $SERVER_PATH ‰∏çÂ≠òÂú®"
            fi

            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"

            # Âä†ËΩΩ.envÁéØÂ¢ÉÂèòÈáèÔºàstandaloneÊ®°Âºè‰∏ç‰ºöËá™Âä®Âä†ËΩΩ.envÔºâ
            if [ -f .env ]; then
              export $(grep -v '^#' .env | grep -v '^\s*$' | xargs)
              echo "‚úÖ Â∑≤Âä†ËΩΩ.envÁéØÂ¢ÉÂèòÈáè"
            fi

            # Ê∏ÖÈô§ÊóßÁöÑÊï∞ÊçÆÁºìÂ≠ò
            if [ -n "$DB_PASSWORD" ]; then
              mysql -u root -p"$DB_PASSWORD" stock_tracker -e "DELETE FROM seven_days_cache;" 2>/dev/null || true
              echo "‚úÖ Â∑≤Ê∏ÖÈô§Êï∞ÊçÆÁºìÂ≠ò"
            fi

            PORT=3001 pm2 start $SERVER_PATH --name $APP_NAME --max-memory-restart 200M
            pm2 save

            rm -f /tmp/bk-build.tar.gz

            echo "‚úÖ BK app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # Á≠âÂæÖÂ∫îÁî®ÂêØÂä®Âπ∂Ê£ÄÊü•Êó•Âøó
            echo "‚è≥ Á≠âÂæÖÂ∫îÁî®ÂêØÂä®..."
            sleep 5
            echo "üìã Ê£ÄÊü•Â∫îÁî®Áä∂ÊÄÅÂíåÊó•Âøó..."
            pm2 status
            echo "üìã ÊúÄËøëÁöÑÂ∫îÁî®Êó•ÂøóÔºö"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "üìã ÈîôËØØÊó•ÂøóÔºö"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # ÈÉ®ÁΩ≤FuplanÂ∫îÁî®(Â§çÁõòÁ≥ªÁªü)
  deploy-fuplan:
    name: Deploy Fuplan App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.fuplan == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'fuplan')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/fuplan-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart fuplan app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/fuplan-system"
            APP_NAME="member-fuplan"

            echo "üöÄ Deploying Fuplan App (Review System)..."

            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.fuplan.backup
            fi

            mkdir -p "$DEPLOY_PATH"

            # Ê∏ÖÁêÜÊóßÁöÑÊûÑÂª∫‰∫ßÁâ©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            cd "$DEPLOY_PATH"
            tar -xzf /tmp/fuplan-build.tar.gz

            if [ -f /tmp/.env.fuplan.backup ]; then
              cp /tmp/.env.fuplan.backup .env
            fi

            # Â§çÂà∂standaloneÊñá‰ª∂Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
            if [ -d ".next/standalone" ]; then
              echo "‚úÖ ÊâæÂà∞standaloneÁõÆÂΩï"

              # Ê£ÄÊü•ÊòØÂê¶ÊòØmonorepoÁªìÊûÑÔºàÊúâappsÂ≠êÁõÆÂΩïÔºâ
              if [ -d ".next/standalone/apps/fuplan" ]; then
                echo "üìÇ Ê£ÄÊµãÂà∞monorepoÁªìÊûÑÔºå‰øùÊåÅÁõÆÂΩïÁªìÊûÑ‰∏çÂèò"

                # Â§çÂà∂.envÂà∞standaloneÊ†πÁõÆÂΩï
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # Â§çÂà∂staticÁõÆÂΩïÂà∞Ê≠£Á°Æ‰ΩçÁΩÆ
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/fuplan/.next
                  cp -r .next/static .next/standalone/apps/fuplan/.next/static
                fi

                echo "‚úÖ ÂáÜÂ§áÂÆåÊàêÔºåÂ∞Ü‰ªé.next/standalone/apps/fuplan/server.jsÂêØÂä®"
                SERVER_PATH=".next/standalone/apps/fuplan/server.js"
              else
                echo "üìÇ Ê£ÄÊµãÂà∞Ê†áÂáÜÁªìÊûÑÔºåÁõ¥Êé•Â§çÂà∂"
                if [ -d ".next/static" ]; then
                  cp -r .next/static /tmp/static-backup-fuplan
                fi

                rm -rf /tmp/standalone-temp-fuplan
                cp -r .next/standalone /tmp/standalone-temp-fuplan

                find . -maxdepth 1 ! -name '.' ! -name '..' ! -name '.env' ! -name '.git' ! -name 'logs' -exec rm -rf {} + 2>/dev/null || true

                cp -r /tmp/standalone-temp-fuplan/* .

                if [ -d "/tmp/static-backup-fuplan" ]; then
                  mkdir -p .next
                  cp -r /tmp/static-backup-fuplan .next/static
                  rm -rf /tmp/static-backup-fuplan
                fi

                rm -rf /tmp/standalone-temp-fuplan
                echo "‚úÖ Â§çÂà∂ÂÆåÊàê"
                SERVER_PATH="server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "‚ùå $SERVER_PATH ‰∏çÂ≠òÂú®"
            fi

            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"
            PORT=3002 pm2 start $SERVER_PATH --name $APP_NAME --max-memory-restart 200M
            pm2 save

            rm -f /tmp/fuplan-build.tar.gz

            echo "‚úÖ Fuplan app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # Á≠âÂæÖÂ∫îÁî®ÂêØÂä®Âπ∂Ê£ÄÊü•Êó•Âøó
            echo "‚è≥ Á≠âÂæÖÂ∫îÁî®ÂêØÂä®..."
            sleep 5
            echo "üìã Ê£ÄÊü•Â∫îÁî®Áä∂ÊÄÅÂíåÊó•Âøó..."
            pm2 status
            echo "üìã ÊúÄËøëÁöÑÂ∫îÁî®Êó•ÂøóÔºö"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "üìã ÈîôËØØÊó•ÂøóÔºö"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # ÈÉ®ÁΩ≤XinliÂ∫îÁî®(ÂøÉÁêÜÊµãËØÑÁ≥ªÁªü)
  deploy-xinli:
    name: Deploy Xinli App
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.xinli == 'true' || github.event.inputs.apps == 'all' || contains(github.event.inputs.apps, 'xinli')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "artifacts/xinli-build.tar.gz"
          target: "/tmp/"
          strip_components: 1

      - name: Extract and restart xinli app
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/xinli-system"
            APP_NAME="member-xinli"

            echo "üöÄ Deploying Xinli App (Psychology System)..."

            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.xinli.backup
            fi

            mkdir -p "$DEPLOY_PATH"

            # Ê∏ÖÁêÜÊóßÁöÑÊûÑÂª∫‰∫ßÁâ©
            rm -rf "$DEPLOY_PATH/.next"
            rm -rf "$DEPLOY_PATH/public"
            rm -rf "$DEPLOY_PATH/server.js"

            cd "$DEPLOY_PATH"
            tar -xzf /tmp/xinli-build.tar.gz

            if [ -f /tmp/.env.xinli.backup ]; then
              cp /tmp/.env.xinli.backup .env
            fi

            # Â§çÂà∂standaloneÊñá‰ª∂Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
            if [ -d ".next/standalone" ]; then
              echo "‚úÖ ÊâæÂà∞standaloneÁõÆÂΩï"

              # Ê£ÄÊü•ÊòØÂê¶ÊòØmonorepoÁªìÊûÑÔºàÊúâappsÂ≠êÁõÆÂΩïÔºâ
              if [ -d ".next/standalone/apps/xinli" ]; then
                echo "üìÇ Ê£ÄÊµãÂà∞monorepoÁªìÊûÑÔºå‰øùÊåÅÁõÆÂΩïÁªìÊûÑ‰∏çÂèò"

                # Â§çÂà∂.envÂà∞standaloneÊ†πÁõÆÂΩï
                if [ -f .env ]; then
                  cp .env .next/standalone/.env
                fi

                # Â§çÂà∂staticÁõÆÂΩïÂà∞Ê≠£Á°Æ‰ΩçÁΩÆ
                if [ -d ".next/static" ]; then
                  mkdir -p .next/standalone/apps/xinli/.next
                  cp -r .next/static .next/standalone/apps/xinli/.next/static
                fi

                echo "‚úÖ ÂáÜÂ§áÂÆåÊàêÔºåÂ∞Ü‰ªé.next/standalone/apps/xinli/server.jsÂêØÂä®"
                SERVER_PATH=".next/standalone/apps/xinli/server.js"
              else
                echo "üìÇ Ê£ÄÊµãÂà∞Ê†áÂáÜÁªìÊûÑÔºåÁõ¥Êé•Â§çÂà∂"
                if [ -d ".next/static" ]; then
                  cp -r .next/static /tmp/static-backup-xinli
                fi

                rm -rf /tmp/standalone-temp-xinli
                cp -r .next/standalone /tmp/standalone-temp-xinli

                find . -maxdepth 1 ! -name '.' ! -name '..' ! -name '.env' ! -name '.git' ! -name 'logs' -exec rm -rf {} + 2>/dev/null || true

                cp -r /tmp/standalone-temp-xinli/* .

                if [ -d "/tmp/static-backup-xinli" ]; then
                  mkdir -p .next
                  cp -r /tmp/static-backup-xinli .next/static
                  rm -rf /tmp/static-backup-xinli
                fi

                rm -rf /tmp/standalone-temp-xinli
                echo "‚úÖ Â§çÂà∂ÂÆåÊàê"
                SERVER_PATH="server.js"
              fi

              ls -la $SERVER_PATH 2>/dev/null || echo "‚ùå $SERVER_PATH ‰∏çÂ≠òÂú®"
            fi

            pm2 describe $APP_NAME > /dev/null 2>&1 && pm2 delete $APP_NAME || true
            cd "$DEPLOY_PATH"
            PORT=3003 pm2 start $SERVER_PATH --name $APP_NAME --max-memory-restart 200M
            pm2 save

            rm -f /tmp/xinli-build.tar.gz

            echo "‚úÖ Xinli app deployed successfully"
            pm2 info $APP_NAME --no-daemon

            # Á≠âÂæÖÂ∫îÁî®ÂêØÂä®Âπ∂Ê£ÄÊü•Êó•Âøó
            echo "‚è≥ Á≠âÂæÖÂ∫îÁî®ÂêØÂä®..."
            sleep 5
            echo "üìã Ê£ÄÊü•Â∫îÁî®Áä∂ÊÄÅÂíåÊó•Âøó..."
            pm2 status
            echo "üìã ÊúÄËøëÁöÑÂ∫îÁî®Êó•ÂøóÔºö"
            pm2 logs $APP_NAME --lines 30 --nostream || true
            echo "üìã ÈîôËØØÊó•ÂøóÔºö"
            pm2 logs $APP_NAME --err --lines 20 --nostream || true

  # ÈÉ®ÁΩ≤ÂêéÂÅ•Â∫∑Ê£ÄÊü•
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy-web, deploy-bk, deploy-fuplan, deploy-xinli]
    if: always() && (needs.deploy-web.result == 'success' || needs.deploy-bk.result == 'success' || needs.deploy-fuplan.result == 'success' || needs.deploy-xinli.result == 'success')

    steps:
      - name: Check deployed apps
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            echo "üìä Application Status:"
            echo "===================="
            pm2 list

            echo ""
            echo "üîç Health Checks:"
            echo "===================="

            # Web App (Port 3000)
            if pm2 describe member-web > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3000 > /dev/null 2>&1 && echo "‚úÖ Web App: Healthy" || echo "‚ùå Web App: Failed"
            fi

            # BK App (Port 3001)
            if pm2 describe member-bk > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3001 > /dev/null 2>&1 && echo "‚úÖ BK App: Healthy" || echo "‚ùå BK App: Failed"
            fi

            # Fuplan App (Port 3002)
            if pm2 describe member-fuplan > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3002 > /dev/null 2>&1 && echo "‚úÖ Fuplan App: Healthy" || echo "‚ùå Fuplan App: Failed"
            fi

            # Xinli App (Port 3003)
            if pm2 describe member-xinli > /dev/null 2>&1; then
              curl -f http://127.0.0.1:3003 > /dev/null 2>&1 && echo "‚úÖ Xinli App: Healthy" || echo "‚ùå Xinli App: Failed"
            fi

            echo ""
            echo "‚úÖ Deployment completed!"
