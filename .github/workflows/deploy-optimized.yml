name: Deploy Member System (Optimized - Legacy Compatible)

# 此workflow用于部署单个member-system应用(旧结构)
# 如果使用Monorepo结构,请使用 deploy-monorepo.yml

on:
  push:
    branches: [main, master]
    paths:
      - "member-system/**"
      - "apps/web/**"
      - ".github/workflows/deploy-optimized.yml"
  workflow_dispatch: {}

concurrency:
  group: deploy-member-system-optimized
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      # 检测是Monorepo还是单仓库结构
      - name: Detect repository structure
        id: detect
        run: |
          if [ -d "apps/web" ]; then
            echo "structure=monorepo" >> $GITHUB_OUTPUT
            echo "work_dir=apps/web" >> $GITHUB_OUTPUT
            echo "📦 Detected Monorepo structure"
          elif [ -d "member-system" ]; then
            echo "structure=single" >> $GITHUB_OUTPUT
            echo "work_dir=member-system" >> $GITHUB_OUTPUT
            echo "📦 Detected Single-repo structure"
          else
            echo "❌ Unable to detect project structure"
            exit 1
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: |
          if [ "${{ steps.detect.outputs.structure }}" == "monorepo" ]; then
            pnpm turbo run build --filter=web
          else
            cd ${{ steps.detect.outputs.work_dir }}
            pnpm run build
          fi

      - name: Prepare deployment files
        run: |
          WORK_DIR="${{ steps.detect.outputs.work_dir }}"
          cd "$WORK_DIR"

          # 创建部署目录
          mkdir -p deploy

          # 复制必要的文件
          cp -r .next deploy/
          cp -r public deploy/
          cp package.json package-lock.json deploy/
          cp next.config.js deploy/
          cp ecosystem.config.js deploy/ 2>/dev/null || echo "No ecosystem.config.js"
          cp -r src deploy/ 2>/dev/null || true

          # 复制数据库脚本
          cp database-init-v3.sql deploy/ 2>/dev/null || true

          echo "✅ Deployment files prepared"
          ls -la deploy/

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "${{ steps.detect.outputs.work_dir }}/deploy/*"
          target: "/tmp/member-system-deploy/"
          strip_components: 2
          rm: false

      - name: Restart application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/member-system"
            TEMP_PATH="/tmp/member-system-deploy"
            APP_NAME="member-web"

            echo "🔍 检查部署目录..."
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "创建部署目录: $DEPLOY_PATH"
              mkdir -p "$DEPLOY_PATH"
            fi

            echo "📦 备份.env文件..."
            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.backup
              echo "✅ .env已备份"
            else
              echo "⚠️  .env文件不存在，部署后需要创建"
            fi

            echo "🔄 同步新文件到部署目录..."
            rsync -av --delete \
              --exclude='.env' \
              --exclude='logs' \
              --exclude='node_modules' \
              "$TEMP_PATH/" "$DEPLOY_PATH/"

            echo "📝 恢复.env文件..."
            if [ -f /tmp/.env.backup ]; then
              cp /tmp/.env.backup "$DEPLOY_PATH/.env"
              echo "✅ .env已恢复"
            fi

            echo "📂 进入部署目录..."
            cd "$DEPLOY_PATH"

            echo "🧹 清理旧的node_modules..."
            rm -rf node_modules package-lock.json

            echo "📦 安装生产依赖..."
            npm install --production --no-audit --prefer-offline

            echo "🔧 检查PM2状态..."
            if pm2 describe member-system > /dev/null 2>&1; then
              echo "停止旧进程: member-system"
              pm2 delete member-system
            fi

            if pm2 describe $APP_NAME > /dev/null 2>&1; then
              echo "停止旧进程: $APP_NAME"
              pm2 stop $APP_NAME
            fi

            echo "🚀 启动应用..."
            if [ -f "ecosystem.config.js" ]; then
              pm2 startOrReload ecosystem.config.js --env production
            else
              pm2 start npm --name $APP_NAME -- start -- -p 3000
            fi
            pm2 save

            echo "🧹 清理临时文件..."
            rm -rf "$TEMP_PATH"

            echo ""
            echo "✅ Deployment completed successfully!"
            echo ""
            echo "📊 Application status:"
            pm2 list

            echo ""
            echo "🌐 测试本地访问..."
            sleep 3
            curl -I http://127.0.0.1:3000 2>&1 | head -5 || echo "⚠️ 应用可能未正常启动"
