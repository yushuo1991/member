name: Deploy Member System (Optimized - Legacy Compatible)

# æ­¤workflowç”¨äºéƒ¨ç½²å•ä¸ªmember-systemåº”ç”¨(æ—§ç»“æ„)
# å¦‚æœä½¿ç”¨Monorepoç»“æ„,è¯·ä½¿ç”¨ deploy-monorepo.yml

on:
  push:
    branches: [main, master]
    paths:
      - "member-system/**"
      - "apps/web/**"
      - ".github/workflows/deploy-optimized.yml"
  workflow_dispatch: {}

concurrency:
  group: deploy-member-system-optimized
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      # æ£€æµ‹æ˜¯Monorepoè¿˜æ˜¯å•ä»“åº“ç»“æ„
      - name: Detect repository structure
        id: detect
        run: |
          if [ -d "apps/web" ]; then
            echo "structure=monorepo" >> $GITHUB_OUTPUT
            echo "work_dir=apps/web" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Detected Monorepo structure"
          elif [ -d "member-system" ]; then
            echo "structure=single" >> $GITHUB_OUTPUT
            echo "work_dir=member-system" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Detected Single-repo structure"
          else
            echo "âŒ Unable to detect project structure"
            exit 1
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: |
          if [ "${{ steps.detect.outputs.structure }}" == "monorepo" ]; then
            pnpm turbo run build --filter=web
          else
            cd ${{ steps.detect.outputs.work_dir }}
            pnpm run build
          fi

      - name: Prepare deployment files
        run: |
          WORK_DIR="${{ steps.detect.outputs.work_dir }}"
          cd "$WORK_DIR"

          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p deploy

          # å¤åˆ¶Next.js standaloneè¾“å‡º
          if [ -d ".next/standalone" ]; then
            echo "ğŸ“¦ Using Next.js standalone output"
            cp -r .next/standalone/. deploy/
            cp -r .next/static deploy/.next/
            cp -r public deploy/
          else
            echo "âš ï¸ No standalone output found, using regular build"
            cp -r .next deploy/
            cp -r public deploy/
            cp package.json deploy/
          fi

          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp next.config.js deploy/ 2>/dev/null || true
          cp ecosystem.config.js deploy/ 2>/dev/null || true

          # å¤åˆ¶æ•°æ®åº“è„šæœ¬
          cp database-init-v3.sql deploy/ 2>/dev/null || true

          echo "âœ… Deployment files prepared"
          ls -la deploy/

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          source: "${{ steps.detect.outputs.work_dir }}/deploy/*"
          target: "/tmp/member-system-deploy/"
          strip_components: 3
          rm: false

      - name: Restart application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e

            DEPLOY_PATH="/www/wwwroot/member-system"
            TEMP_PATH="/tmp/member-system-deploy"
            APP_NAME="member-web"

            echo "ğŸ” æ£€æŸ¥éƒ¨ç½²ç›®å½•..."
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "åˆ›å»ºéƒ¨ç½²ç›®å½•: $DEPLOY_PATH"
              mkdir -p "$DEPLOY_PATH"
            fi

            echo "ğŸ“¦ å¤‡ä»½.envæ–‡ä»¶..."
            if [ -f "$DEPLOY_PATH/.env" ]; then
              cp "$DEPLOY_PATH/.env" /tmp/.env.backup
              echo "âœ… .envå·²å¤‡ä»½"
            else
              echo "âš ï¸  .envæ–‡ä»¶ä¸å­˜åœ¨ï¼Œéƒ¨ç½²åéœ€è¦åˆ›å»º"
            fi

            echo "ğŸ”„ åŒæ­¥æ–°æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•..."
            rsync -av --delete \
              --exclude='.env' \
              --exclude='logs' \
              --exclude='node_modules' \
              "$TEMP_PATH/" "$DEPLOY_PATH/"

            # åŒæ­¥å®Œæ•´æ„å»ºäº§ç‰©åˆ°member-monorepoè·¯å¾„ï¼ˆå› ä¸ºPM2ä»è¿™é‡Œè¿è¡Œï¼‰
            MONOREPO_PATH="/www/wwwroot/member-monorepo/apps/web"
            if [ -d "$MONOREPO_PATH" ]; then
              echo "ğŸ“¦ åŒæ­¥å®Œæ•´æ„å»ºäº§ç‰©åˆ°monorepoè·¯å¾„..."

              # å¤‡ä»½monorepoçš„.envæ–‡ä»¶
              if [ -f "$MONOREPO_PATH/.env" ]; then
                cp "$MONOREPO_PATH/.env" /tmp/.env.monorepo.backup
              fi

              # åŒæ­¥æ‰€æœ‰æ–‡ä»¶ï¼ˆæ’é™¤.envå’Œnode_modulesï¼‰
              rsync -av --delete \
                --exclude='.env' \
                --exclude='node_modules' \
                --exclude='logs' \
                "$TEMP_PATH/" "$MONOREPO_PATH/"

              # æ¢å¤monorepoçš„.envæ–‡ä»¶
              if [ -f /tmp/.env.monorepo.backup ]; then
                cp /tmp/.env.monorepo.backup "$MONOREPO_PATH/.env"
              fi

              echo "âœ… Monorepoå®Œæ•´æ„å»ºäº§ç‰©å·²åŒæ­¥"
            fi

            echo "ğŸ“ æ¢å¤.envæ–‡ä»¶..."
            if [ -f /tmp/.env.backup ]; then
              cp /tmp/.env.backup "$DEPLOY_PATH/.env"
              echo "âœ… .envå·²æ¢å¤"
            fi

            echo "ğŸ“‚ è¿›å…¥éƒ¨ç½²ç›®å½•..."
            cd "$DEPLOY_PATH"

            echo "ğŸ“¦ å®‰è£…sharpä¾èµ–ï¼ˆå›¾ç‰‡ä¼˜åŒ–å¿…éœ€ï¼‰..."
            npm install sharp@0.33.5 --no-save || echo "âš ï¸ sharpå®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"

            echo "ğŸ”§ æ£€æŸ¥PM2çŠ¶æ€..."
            if pm2 describe member-system > /dev/null 2>&1; then
              echo "åœæ­¢æ—§è¿›ç¨‹: member-system"
              pm2 delete member-system
            fi

            if pm2 describe $APP_NAME > /dev/null 2>&1; then
              echo "åœæ­¢æ—§è¿›ç¨‹: $APP_NAME"
              pm2 stop $APP_NAME
            fi

            echo "ğŸš€ å¯åŠ¨åº”ç”¨..."
            if [ -f "server.js" ]; then
              # ä½¿ç”¨standaloneæ¨¡å¼å¯åŠ¨
              pm2 start server.js --name $APP_NAME --node-args="--max-old-space-size=2048"
            elif [ -f "ecosystem.config.js" ]; then
              pm2 startOrReload ecosystem.config.js --env production
            else
              pm2 start npm --name $APP_NAME -- start -- -p 3000
            fi
            pm2 save

            echo ""
            echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 5

            echo ""
            echo "ğŸ“Š PM2åº”ç”¨çŠ¶æ€:"
            pm2 list

            echo ""
            echo "ğŸ“‹ æŸ¥çœ‹åº”ç”¨æ—¥å¿— (æœ€è¿‘50è¡Œ):"
            pm2 logs $APP_NAME --lines 50 --nostream || echo "æ— æ³•è·å–æ—¥å¿—"

            echo ""
            echo "ğŸ” æ£€æŸ¥åº”ç”¨è¿›ç¨‹çŠ¶æ€:"
            pm2 describe $APP_NAME || echo "æ— æ³•è·å–è¿›ç¨‹è¯¦æƒ…"

            echo ""
            echo "ğŸŒ æµ‹è¯•æœ¬åœ°è®¿é—®..."
            for i in {1..3}; do
              echo "å°è¯• $i/3..."
              if curl -f -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000; then
                echo "âœ… åº”ç”¨å“åº”æ­£å¸¸"
                break
              else
                echo "âš ï¸ åº”ç”¨æœªå“åº”ï¼Œç­‰å¾…3ç§’åé‡è¯•..."
                sleep 3
              fi
            done

            echo ""
            echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -rf "$TEMP_PATH"

            echo ""
            echo "âœ… Deployment completed!"
