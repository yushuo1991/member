name: Server Maintenance

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - diagnose-bk-data
          - check-bk-amounts
          - preload-bk-date
          - snapshot-test
          - server-status
          - custom-command
      date:
        description: 'Date for preload (YYYY-MM-DD)'
        required: false
        default: '2025-02-13'
      command:
        description: 'Custom command (only for custom-command action)'
        required: false

jobs:
  maintenance:
    name: Run Maintenance Task
    runs-on: ubuntu-latest
    steps:
      - name: Execute on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            ACTION="${{ github.event.inputs.action }}"
            TARGET_DATE="${{ github.event.inputs.date }}"

            echo "========================================="
            echo "Action: $ACTION"
            echo "Date: $TARGET_DATE"
            echo "========================================="

            if [ "$ACTION" = "server-status" ]; then
              echo "=== 内存 ==="
              free -h
              echo ""
              echo "=== PM2进程 ==="
              pm2 list
              echo ""
              echo "=== 磁盘 ==="
              df -h /
              echo ""
              echo "=== MySQL状态 ==="
              mysql -u root -p'ChangeMe2026!Secure' -e "SHOW STATUS LIKE 'Threads_connected';" 2>/dev/null

            elif [ "$ACTION" = "diagnose-bk-data" ]; then
              echo "=== 检查涨停数据 ==="
              mysql -u root -p'ChangeMe2026!Secure' stock_tracker -e "
                SELECT trade_date, COUNT(*) as stocks
                FROM limit_up_stocks
                WHERE trade_date >= DATE_SUB('$TARGET_DATE', INTERVAL 5 DAY)
                  AND trade_date <= DATE_ADD('$TARGET_DATE', INTERVAL 5 DAY)
                GROUP BY trade_date
                ORDER BY trade_date;" 2>/dev/null

              echo ""
              echo "=== 检查溢价数据 ==="
              mysql -u root -p'ChangeMe2026!Secure' stock_tracker -e "
                SELECT base_date, COUNT(*) as records
                FROM stock_performance
                WHERE base_date >= DATE_SUB('$TARGET_DATE', INTERVAL 5 DAY)
                  AND base_date <= DATE_ADD('$TARGET_DATE', INTERVAL 5 DAY)
                GROUP BY base_date
                ORDER BY base_date;" 2>/dev/null

              echo ""
              echo "=== 检查缓存 ==="
              mysql -u root -p'ChangeMe2026!Secure' stock_tracker -e "
                SELECT trade_date, LENGTH(data) as data_size
                FROM seven_days_cache
                WHERE trade_date >= DATE_SUB('$TARGET_DATE', INTERVAL 5 DAY)
                  AND trade_date <= DATE_ADD('$TARGET_DATE', INTERVAL 5 DAY)
                ORDER BY trade_date;" 2>/dev/null

              echo ""
              echo "=== 测试BK API ==="
              curl -s "http://localhost:3001/api/stocks?mode=7days&date=$TARGET_DATE" | python3 -c "
              import sys,json
              try:
                d=json.load(sys.stdin)
                dates=d.get('dates',[])
                print(f'返回日期数: {len(dates)}')
                print(f'日期列表: {dates}')
                data=d.get('data',{})
                for dt in sorted(data.keys()):
                  cats=data[dt].get('categories',{})
                  print(f'{dt}: {len(cats)}个板块')
              except Exception as e:
                print(f'解析失败: {e}')
              " 2>/dev/null

              echo ""
              echo "=== BK最近日志 ==="
              pm2 logs member-bk --lines 10 --nostream 2>&1 | grep -v TAILING | tail -10

            elif [ "$ACTION" = "check-bk-amounts" ]; then
              echo "=== 检查个股成交额 ==="
              curl -s "http://localhost:3001/api/stocks?mode=7days&date=$TARGET_DATE" > /tmp/bk-check.json
              printf 'import json,sys,os\ntarget_date=os.environ.get("TARGET_DATE_FOR_PY","")\nwith open("/tmp/bk-check.json") as f:\n d=json.load(f)\ndata=d.get("data",{})\ndates=sorted(data.keys())\nprint("dates:",dates)\nuse_date=target_date if target_date in data else (dates[-1] if dates else "")\ntarget=data.get(use_date,{})\ncats=target.get("categories",{})\nsa=target.get("sectorAmounts",{})\nprint("=== sectorAmounts ===")\nfor k,v in sorted(sa.items(),key=lambda x:-x[1]):\n print("  %%s: %%s"%%(k,v))\nprint()\nprint("=== per-stock amounts (first 4 sectors) ===")\nfor sector,stocks in list(cats.items())[:4]:\n print("%%s:"%%sector)\n for s in stocks[:6]:\n  print("  %%s(%%s): %%s"%%(s["name"],s["code"],s["amount"]))\n print()\nprint("=== duplicate amount check ===")\nall_amts={}\nfor sector,stocks in cats.items():\n for s in stocks:\n  a=s["amount"]\n  if a not in all_amts:\n   all_amts[a]=[]\n  all_amts[a].append("%%s(%%s)"%%(s["name"],sector))\ndupes=sorted([(k,v) for k,v in all_amts.items() if len(v)>2],key=lambda x:-len(x[1]))\nfor amt,names in dupes[:5]:\n print("  amount=%%s: %%d stocks - %%s"%%(amt,len(names),names[:5]))\nif not dupes:\n print("  No significant duplicates found")\nprint()\nprint("=== zero amounts ===")\nzeros=all_amts.get(0,[])\nprint("  %%d stocks with amount=0"%%len(zeros))\nif zeros:\n print("  %%s"%%zeros[:10])\n' > /tmp/check_amounts.py
              TARGET_DATE_FOR_PY="$TARGET_DATE" python3 /tmp/check_amounts.py

            elif [ "$ACTION" = "preload-bk-date" ]; then
              echo "=== 清除${TARGET_DATE}缓存 ==="
              mysql -u root -p'ChangeMe2026!Secure' stock_tracker -e "
                DELETE FROM seven_days_cache WHERE trade_date = '$TARGET_DATE';" 2>/dev/null
              echo "缓存已清除"

              echo ""
              echo "=== 预加载${TARGET_DATE}数据 ==="
              RESULT=$(curl -s -X POST "http://localhost:3001/api/cron?action=preload&date=$TARGET_DATE")
              echo "$RESULT" | python3 -c "
              import sys,json
              try:
                d=json.load(sys.stdin)
                print(json.dumps(d, indent=2, ensure_ascii=False))
              except:
                print(sys.stdin.read())
              " 2>/dev/null

              echo ""
              echo "=== 验证数据 ==="
              sleep 3
              mysql -u root -p'ChangeMe2026!Secure' stock_tracker -e "
                SELECT base_date, COUNT(*) as records
                FROM stock_performance
                WHERE base_date = '$TARGET_DATE'
                GROUP BY base_date;" 2>/dev/null

              echo ""
              echo "=== 重新请求API验证 ==="
              curl -s "http://localhost:3001/api/stocks?mode=7days&date=$TARGET_DATE" | python3 -c "
              import sys,json
              try:
                d=json.load(sys.stdin)
                dates=d.get('dates',[])
                print(f'返回日期数: {len(dates)}')
                data=d.get('data',{})
                for dt in sorted(data.keys()):
                  cats=data[dt].get('categories',{})
                  fu=data[dt].get('followUpData',{})
                  print(f'{dt}: {len(cats)}个板块, followUp={len(fu)}个板块')
              except Exception as e:
                print(f'解析失败: {e}')
              " 2>/dev/null

            elif [ "$ACTION" = "snapshot-test" ]; then
              echo "=== 获取${TARGET_DATE}涨停股票 ==="
              STOCKS_JSON=$(curl -s "http://localhost:3001/api/stocks?date=$TARGET_DATE&mode=single")
              echo "$STOCKS_JSON" | python3 -c "
              import sys,json
              d=json.load(sys.stdin)
              cats=d.get('data',{}).get('categories',{})
              stocks=[{'code':s['code'],'name':s['name']} for sl in cats.values() for s in sl]
              print(f'找到 {len(stocks)} 只涨停股票')
              # 只取前20只测试
              test_stocks=stocks[:20]
              payload={'date':'$TARGET_DATE','stocks':test_stocks}
              json.dump(payload,open('/tmp/snap-test.json','w'))
              print(f'将保存前 {len(test_stocks)} 只的分时图')
              " 2>/dev/null

              echo ""
              echo "=== 保存分时图快照 ==="
              curl -s -X POST http://localhost:3001/api/minute-snapshot -H 'Content-Type: application/json' -d @/tmp/snap-test.json | python3 -c "
              import sys,json
              d=json.load(sys.stdin)
              print(json.dumps(d, indent=2, ensure_ascii=False))
              " 2>/dev/null

              echo ""
              echo "=== 验证快照 ==="
              mysql -u root -p'ChangeMe2026!Secure' stock_tracker -e "
                SELECT trade_date, COUNT(*) as snapshots, SUM(file_size) as total_bytes
                FROM minute_chart_snapshots
                GROUP BY trade_date
                ORDER BY trade_date DESC
                LIMIT 5;" 2>/dev/null

              echo ""
              echo "=== 磁盘占用 ==="
              du -sh /www/wwwroot/bk-system/data/minute-snapshots/ 2>/dev/null || echo "目录不存在"
              ls -la /www/wwwroot/bk-system/data/minute-snapshots/$TARGET_DATE/ 2>/dev/null | head -10 || echo "无该日期快照"

            elif [ "$ACTION" = "custom-command" ]; then
              CUSTOM_CMD="${{ github.event.inputs.command }}"
              if [ -n "$CUSTOM_CMD" ]; then
                echo "=== 执行自定义命令 ==="
                eval "$CUSTOM_CMD"
              else
                echo "未提供自定义命令"
              fi
            fi

            echo ""
            echo "========================================="
            echo "✅ 维护任务完成"
            echo "========================================="
