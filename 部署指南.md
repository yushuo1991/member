# 首页优化部署指南

## 当前状态
- ✅ 代码已优化完成
- ✅ 本地构建测试通过
- ✅ Git提交已完成 (commit: 6bfdba5)
- ⏳ 待推送到GitHub（网络问题）

## 快速部署步骤

### 方法1：自动部署（推荐）

当网络恢复后，执行：

```bash
cd "C:\Users\yushu\Desktop\我的会员体系"
git push origin main
```

GitHub Actions将自动：
1. 构建应用（约2-3分钟）
2. 部署到服务器 yushuofupan.com
3. 重启PM2服务
4. 完成部署

查看部署状态：
- 访问：https://github.com/yushuo1991/member/actions

### 方法2：手动部署

如果GitHub Actions失败，可以手动部署：

#### 1. 连接服务器
```bash
ssh root@yushuofupan.com
```

#### 2. 进入项目目录
```bash
cd /www/wwwroot/member-system
```

#### 3. 拉取最新代码
```bash
git pull origin main
```

#### 4. 安装依赖（如有新增）
```bash
npm ci --only=production
```

#### 5. 构建应用
```bash
npm run build
```

#### 6. 重启服务
```bash
pm2 restart member-system
pm2 logs member-system --lines 50
```

#### 7. 检查服务状态
```bash
pm2 status
curl http://localhost:3000
```

### 方法3：本地构建+上传（备用）

如果服务器构建失败：

#### 1. 本地构建
```bash
cd "C:\Users\yushu\Desktop\我的会员体系\member-system"
npm run build
```

#### 2. 打包standalone目录
```bash
# 压缩.next/standalone目录
tar -czf standalone.tar.gz .next/standalone
```

#### 3. 上传到服务器
```bash
scp standalone.tar.gz root@yushuofupan.com:/tmp/
```

#### 4. 服务器端解压
```bash
ssh root@yushuofupan.com
cd /www/wwwroot/member-system
rm -rf .next
tar -xzf /tmp/standalone.tar.gz
mv .next/standalone .next
pm2 restart member-system
```

## 验证部署

### 1. 检查首页
访问：http://yushuofupan.com

预期看到：
- 精致的产品卡片
- 每个产品都有图片
- 移动端布局良好
- 没有重复产品

### 2. 检查产品数量
首页应该显示7个产品（已去除2个重复）：
1. 学习圈
2. 板块助手
3. 板块节奏系统
4. 心理测评系统
5. 复盘系统
6. 情绪表格(2022起)
7. 情绪表格(2018起)
8. 复盘版面
9. 简单复盘

总共9个产品（原11个，删除2个重复）

### 3. 移动端测试
- 使用手机访问或Chrome DevTools
- 检查图片显示
- 检查布局响应
- 检查按钮大小

### 4. 性能检测
```bash
# 使用Lighthouse
- 访问 PageSpeed Insights
- 输入：http://yushuofupan.com
- 检查性能评分
```

## 回滚方案

如果部署出现问题：

### 1. 快速回滚到上一版本
```bash
cd /www/wwwroot/member-system
git log --oneline -5  # 查看最近5个提交
git reset --hard <上一个commit的hash>  # 例如: 1f54e9c
npm run build
pm2 restart member-system
```

### 2. 临时禁用新功能
如果只是图片加载问题，可以：

编辑 `next.config.js`：
```javascript
images: {
  remotePatterns: [],  // 临时禁用外部图片
  formats: ['image/avif', 'image/webp'],
}
```

重新构建部署。

## 常见问题

### Q1: 图片不显示
**原因**：Unsplash图片被墙或网络问题
**解决**：
1. 检查服务器是否能访问images.unsplash.com
2. 替换为国内CDN图片
3. 使用本地图片

### Q2: 布局错乱
**原因**：CSS未正确编译
**解决**：
```bash
rm -rf .next
npm run build
```

### Q3: 服务无法启动
**原因**：端口占用或配置错误
**解决**：
```bash
pm2 logs member-system --err --lines 100
lsof -i :3000
```

## 监控与日志

### PM2日志
```bash
# 实时日志
pm2 logs member-system

# 错误日志
pm2 logs member-system --err

# 清空日志
pm2 flush
```

### Nginx日志
```bash
# 访问日志
tail -f /var/log/nginx/access.log

# 错误日志
tail -f /var/log/nginx/error.log
```

## 性能优化建议

部署后可考虑：

1. **启用CDN**
   - 将图片上传到阿里云OSS
   - 配置CDN加速

2. **图片优化**
   - 压缩图片大小
   - 使用webp格式
   - 设置合适的缓存策略

3. **服务器优化**
   - 启用gzip压缩
   - 配置浏览器缓存
   - 使用HTTP/2

## 联系支持

如遇问题：
1. 检查GitHub Actions日志
2. 查看PM2日志
3. 检查Nginx配置
4. 联系技术支持

---

**创建时间**：2026-01-24
**Git提交**：6bfdba5
**优化内容**：首页产品展示图片化、移动端优化
