# 🚀 Monorepo生产环境部署计划

**目标**: 将Monorepo直接部署到服务器，替换旧的member-system

**服务器**: 8.153.110.212
**部署时间**: 预计10-15分钟
**停机时间**: 约2-3分钟

---

## 📋 部署步骤概览

### 第1步: 创建完整备份 (2分钟)
**操作**:
- 备份旧系统代码到 `/www/wwwroot/backups/member-system-backup-时间戳.tar.gz`
- 备份数据库到 `/www/wwwroot/backups/member-system-db-时间戳.sql`

**安全性**: ✅ 完全可回滚

---

### 第2步: 停止旧系统服务 (30秒)
**操作**:
```bash
pm2 stop member-system
```

**影响**: ⚠️ 旧系统停止服务（开始停机）

---

### 第3步: 上传Monorepo代码 (3-5分钟)
**操作**:
- 使用rsync从本地上传代码到服务器
- 排除: node_modules, .next, .git, .env
- 上传到临时目录

**网络**: 需要稳定的网络连接

---

### 第4步: 部署新系统 (5-8分钟)
**操作**:
1. 复制代码到 `/www/wwwroot/member-monorepo`
2. 创建4个应用的.env配置文件
3. 运行 `pnpm install --prod` (安装生产依赖)
4. 运行 `pnpm build` (构建所有4个应用)

**配置内容** (.env文件):
```env
# 数据库
DB_HOST=localhost        # 本地MySQL
DB_PORT=3306
DB_USER=root
DB_PASSWORD=ChangeMe2026!Secure
DB_NAME=member_system    # 使用现有数据库

# 应用端口
Web:    3000
BK:     3001
Fuplan: 3002
Xinli:  3003
```

---

### 第5步: 配置PM2进程管理 (1分钟)
**操作**:
- 创建 `ecosystem.config.js` (4个应用的PM2配置)
- 每个应用独立进程
- 自动重启
- 日志管理

**进程列表**:
```
member-web     端口3000  (会员管理系统)
member-bk      端口3001  (板块节奏系统)
member-fuplan  端口3002  (复盘系统)
member-xinli   端口3003  (心理测评系统)
```

---

### 第6步: 启动所有服务 (1分钟)
**操作**:
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

**结果**: ✅ 4个应用同时启动（结束停机）

---

### 第7步: 健康检查 (1分钟)
**验证**:
- 访问 http://8.153.110.212:3000 (Web)
- 访问 http://8.153.110.212:3001 (BK)
- 访问 http://8.153.110.212:3002 (Fuplan)
- 访问 http://8.153.110.212:3003 (Xinli)

**检查点**:
- ✅ 所有端口可访问
- ✅ PM2进程正常运行
- ✅ 无错误日志

---

## 🔄 回滚方案

如果部署出现问题，5分钟内回滚：

```bash
# SSH登录服务器
ssh root@8.153.110.212

# 停止新系统
pm2 stop all

# 恢复旧系统
cd /www/wwwroot/backups
tar -xzf member-system-backup-*.tar.gz -C /www/wwwroot/

# 恢复数据库（如果修改了）
mysql -u root -p member_system < member-system-db-*.sql

# 启动旧系统
cd /www/wwwroot/member-system
pm2 start ecosystem.config.js
```

---

## ⚠️ 注意事项

### 1. 数据库兼容性
- ✅ 使用现有的 `member_system` 数据库
- ✅ 不修改数据库结构
- ✅ 所有数据保持不变

### 2. 端口使用
- Web应用继续使用3000端口（与旧系统相同）
- 新增3个应用使用3001-3003端口

### 3. Nginx配置
如果您有Nginx反向代理，无需修改配置：
- 80端口 → 3000端口（Web应用）
- 新应用需要配置反向代理（可选，后续操作）

### 4. 环境变量
所有敏感信息（密码）在服务器端配置，不会从本地上传

---

## 📊 部署前检查清单

- [ ] 服务器SSH连接正常
- [ ] 本地代码已推送到GitHub（当前已完成）
- [ ] 了解回滚步骤
- [ ] 可以接受2-3分钟停机时间
- [ ] 确认数据库密码: ChangeMe2026!Secure

---

## 🎯 部署后验证清单

- [ ] 访问Web应用首页 (http://8.153.110.212:3000)
- [ ] 测试用户登录功能
- [ ] 测试用户注册功能
- [ ] 访问BK应用 (http://8.153.110.212:3001)
- [ ] 访问Fuplan应用 (http://8.153.110.212:3002)
- [ ] 访问Xinli应用 (http://8.153.110.212:3003)
- [ ] 检查PM2进程状态: `pm2 list`
- [ ] 检查应用日志: `pm2 logs`

---

## 💡 关键优势

### 相比旧系统
1. **4个系统合一**: 一次部署，4个应用
2. **代码复用**: 70%代码共享，维护更简单
3. **独立运行**: 每个应用独立进程，互不影响
4. **易于管理**: 统一的PM2管理
5. **快速扩展**: 添加新应用只需几分钟

### 安全保障
1. **完整备份**: 代码 + 数据库
2. **快速回滚**: 5分钟恢复
3. **零数据丢失**: 使用现有数据库
4. **渐进验证**: 逐步测试每个应用

---

## 🚀 执行部署

### 方式1: 自动化脚本（推荐）
```bash
cd "C:\Users\yushu\Desktop\我的会员体系"
bash deploy-to-production.sh
```

**特点**:
- ✅ 全自动执行
- ✅ 逐步确认
- ✅ 实时进度显示
- ✅ 完整日志记录

### 方式2: 手动执行
按照上述步骤1-7，逐步在服务器上操作

---

## ❓ 常见问题

### Q1: 部署过程中遇到错误怎么办？
**A**: 立即执行回滚命令，恢复旧系统。所有数据都有备份。

### Q2: 部署完成后访问不了怎么办？
**A**: 检查PM2状态和日志：
```bash
pm2 list        # 查看进程状态
pm2 logs        # 查看错误日志
```

### Q3: 数据会丢失吗？
**A**: 不会。我们使用现有的member_system数据库，只是换了应用代码。

### Q4: 可以保留旧系统吗？
**A**: 可以。备份在 `/www/wwwroot/backups/`，随时可恢复。

### Q5: 需要停机多久？
**A**: 约2-3分钟（步骤2到步骤6之间）

---

## 📞 准备好了吗？

**现在可以选择**:

1. ✅ **立即部署** - 运行部署脚本
2. 📝 **调整配置** - 修改端口、数据库等设置
3. 🤔 **再想想** - 先在测试环境试试

---

**创建时间**: 2026-01-24
**部署方式**: 直接替换
**风险等级**: 低（有完整备份）
**预期时间**: 10-15分钟
