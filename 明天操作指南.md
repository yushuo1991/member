# 明天醒来后的操作指南

**生成时间**: 2026-01-24 晚
**状态**: GitHub连接失败，已准备好手动部署方案

---

## 📋 当前情况

### ✅ 已完成的工作

1. **全面修复28个问题**（本地代码已完成）：
   - 数据库架构统一（v3）
   - 注册功能修复
   - 会员管理完整CRUD
   - 搜索、筛选、分页功能
   - Toast通知系统
   - 审计日志记录

2. **本地Git提交**：
   - Commit: `5301f7f` - 全面修复
   - Commit: `ded852c` - 修复部署路径
   - **状态**: 已提交但未推送（GitHub连接443端口失败）

### ❌ 未完成的工作

1. **代码未推送到GitHub**
   - 原因: `fatal: unable to access 'https://github.com/yushuo1991/member.git/': Failed to connect to github.com port 443`
   - 可能原因: 防火墙、代理、或ISP限制

2. **服务器未部署**
   - 当前服务器仍运行旧代码
   - 数据库未迁移到v3架构

---

## 🚀 明天的操作步骤（3选1）

### 方案1: 修复GitHub连接后推送（推荐）

```bash
# 1. 检查GitHub连接
ping github.com

# 2. 如果可以ping通，尝试推送
cd "C:\Users\yushu\Desktop\我的会员体系"
git push origin main

# 3. 访问GitHub Actions查看部署
# https://github.com/yushuo1991/member/actions

# 4. 等待5-8分钟部署完成

# 5. 执行数据库迁移（SSH到服务器）
ssh root@8.153.110.212
mysql -u root -p member_system < /www/wwwroot/member-system/database-init-v3.sql
# 密码: ChangeMe2026!Secure

# 6. 重启PM2
pm2 restart member-system
pm2 logs member-system --lines 50

# 7. 测试网站
# 访问: http://yushuofupan.com
```

---

### 方案2: 使用自动化批处理脚本（最简单）

**文件**: `自动部署和测试.bat`（已创建在项目根目录）

```bash
# 直接双击运行:
自动部署和测试.bat

# 或者在CMD中:
cd "C:\Users\yushu\Desktop\我的会员体系"
自动部署和测试.bat
```

**脚本会自动完成**:
1. 本地构建应用
2. 上传到服务器
3. 部署文件
4. 执行数据库迁移
5. 重启PM2
6. 测试所有功能
7. 生成测试报告

**预计时间**: 10-15分钟

---

### 方案3: 手动SSH部署（最可控）

```bash
# 1. 本地构建
cd "C:\Users\yushu\Desktop\我的会员体系\member-system"
npm ci
npm run build

# 2. 打包文件
cd ..
tar -czf deploy.tar.gz member-system/.next member-system/public member-system/src member-system/*.json member-system/*.js member-system/*.sql

# 3. 上传到服务器
scp deploy.tar.gz root@8.153.110.212:/tmp/

# 4. SSH到服务器
ssh root@8.153.110.212

# 5. 在服务器上执行：
cd /tmp
tar -xzf deploy.tar.gz

# 备份.env
cp /www/wwwroot/member-system/.env /tmp/.env.backup

# 同步文件
rsync -av --exclude='.env' --exclude='node_modules' --exclude='logs' \
  /tmp/member-system/ /www/wwwroot/member-system/

# 恢复.env
cp /tmp/.env.backup /www/wwwroot/member-system/.env

# 安装依赖
cd /www/wwwroot/member-system
rm -rf node_modules
npm install --production

# 数据库迁移
mysql -u root -p member_system < database-init-v3.sql
# 密码: ChangeMe2026!Secure

# 重启PM2
pm2 restart member-system
pm2 save
pm2 logs member-system --lines 50

# 测试
curl http://127.0.0.1:3000

# 6. 退出服务器
exit

# 7. 本地测试
curl http://yushuofupan.com
```

---

## 🧪 部署后测试检查清单

### 基础功能测试

- [ ] **网站可访问**: http://yushuofupan.com
- [ ] **管理后台可访问**: http://yushuofupan.com/admin/login

### 用户注册测试

```bash
# 测试注册API
curl -X POST http://yushuofupan.com/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test123","password":"Test123456"}'

# 预期: 返回200和成功消息
```

- [ ] 注册成功返回200
- [ ] 新用户在数据库中可见
- [ ] memberships表有对应记录
- [ ] 试用次数初始化为5

### 管理后台测试

登录信息:
- 用户名: `admin`
- 密码: `7287843Wu`

测试项目:
- [ ] 登录成功
- [ ] 控制台显示真实统计数据（非Mock）
- [ ] 会员列表显示真实用户（非张三李四）
- [ ] 搜索功能正常
- [ ] 筛选功能正常
- [ ] 分页功能正常

### 会员管理功能测试

- [ ] **编辑会员**: 点击编辑图标，调整等级，保存成功
- [ ] **冻结会员**: 点击冻结按钮，状态变为"已冻结"
- [ ] **解冻会员**: 再次点击，状态恢复正常
- [ ] **删除会员**: 点击删除，确认后用户消失（软删除）
- [ ] **Toast通知**: 所有操作都有成功/失败提示

### 数据库验证

```bash
ssh root@8.153.110.212
mysql -u root -p member_system

# 检查表结构
DESCRIBE memberships;
DESCRIBE users;
SELECT COUNT(*) FROM memberships;

# 检查审计日志
SELECT * FROM admin_audit_logs ORDER BY created_at DESC LIMIT 5;

# 检查试用字段
SELECT username, trial_bk, trial_xinli, trial_fuplan, status FROM users LIMIT 5;

exit
```

- [ ] memberships表存在且有数据
- [ ] users表有trial_*字段
- [ ] users表有status字段
- [ ] users表有deleted_at字段
- [ ] admin_audit_logs表记录管理员操作

---

## ⚠️ 常见问题及解决方案

### 问题1: GitHub无法连接

**症状**: `Failed to connect to github.com port 443`

**解决方案**:
1. 检查防火墙/代理设置
2. 尝试使用手机热点
3. 使用SSH方式推送: `git remote set-url origin git@github.com:yushuo1991/member.git`
4. 或直接使用方案2/3手动部署

### 问题2: 数据库迁移失败

**症状**: `Table 'memberships' already exists`

**解决方案**:
```sql
-- 跳过表创建错误，仅迁移数据
INSERT IGNORE INTO memberships (user_id, level, expires_at, activated_at)
SELECT id, COALESCE(membership_level, 'none'), membership_expiry, created_at
FROM users;
```

### 问题3: PM2重启后应用崩溃

**检查日志**:
```bash
pm2 logs member-system --lines 100
```

**常见原因**:
- .env文件缺失 → 从.env.example复制
- 数据库连接失败 → 检查密码和端口
- node_modules缺失 → 重新 `npm install --production`

### 问题4: 注册仍然失败

**检查**:
```bash
mysql -u root -p member_system -e "SHOW TABLES LIKE 'memberships';"
```

如果表不存在，手动创建：
```sql
CREATE TABLE memberships (
  id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id INT UNSIGNED NOT NULL UNIQUE,
  level ENUM('none', 'monthly', 'quarterly', 'yearly', 'lifetime') DEFAULT 'none',
  expires_at TIMESTAMP NULL,
  activated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 📊 验证成功的标志

当你看到以下情况，说明部署完全成功：

1. ✅ 网站 http://yushuofupan.com 可访问
2. ✅ 新用户可以成功注册
3. ✅ 管理后台显示真实数据（不再是Mock）
4. ✅ 会员管理的所有按钮都能正常工作
5. ✅ Toast通知正常显示
6. ✅ PM2显示应用online状态
7. ✅ 数据库有memberships表和数据
8. ✅ admin_audit_logs表记录管理员操作

---

## 📝 文件清单

**已创建的文件**:
1. `自动部署和测试.bat` - 一键自动化脚本
2. `deploy-direct.sh` - Linux部署脚本
3. `FIXES_REPORT_2026-01-24.md` - 详细修复报告
4. `member-system/DATABASE_V3_MIGRATION_GUIDE.md` - 数据库迁移指南
5. `架构修复报告-v3.md` - 架构变更文档
6. `明天操作指南.md` - 本文件

**已修改的文件**（未推送）:
1. `src/lib/database.ts`
2. `src/app/api/auth/register/route.ts`
3. `src/app/admin/page.tsx`
4. `src/app/admin/members/page.tsx`
5. `src/app/api/admin/members/route.ts`
6. `src/app/api/admin/members/[id]/route.ts`（新建）
7. `src/app/api/admin/members/[id]/status/route.ts`（新建）
8. `src/app/api/admin/members/[id]/adjust/route.ts`

---

## 🎯 推荐操作流程

**明天醒来后，推荐按以下顺序操作**:

1. **尝试推送Git**（2分钟）
   ```bash
   cd "C:\Users\yushu\Desktop\我的会员体系"
   git push origin main
   ```
   - 如果成功 → 等待GitHub Actions完成 → 跳到步骤3
   - 如果失败 → 继续步骤2

2. **运行自动化脚本**（15分钟）
   ```bash
   双击: 自动部署和测试.bat
   ```
   - 脚本会自动完成所有部署和测试
   - 查看生成的"部署测试报告.txt"

3. **执行测试检查清单**（10分钟）
   - 逐项测试上面的功能
   - 确认所有✅都打勾

4. **验证成功**
   - 访问 http://yushuofupan.com
   - 测试注册新用户
   - 登录管理后台验证功能

**总耗时**: 约30分钟

---

## 💤 晚安！

所有修复代码都已准备就绪，只差部署这最后一步。

明天醒来后，选择上面任意方案执行即可。

如有任何问题，查看详细报告：
- **FIXES_REPORT_2026-01-24.md** - 完整修复内容
- **DATABASE_V3_MIGRATION_GUIDE.md** - 数据库操作指南

祝你好梦！🌙
