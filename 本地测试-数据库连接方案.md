# 本地测试数据库连接问题解决方案

## 问题诊断

**错误**: `Error: connect ETIMEDOUT 8.153.110.212:3306`

**原因**: 远程MySQL服务器(8.153.110.212)的3306端口未对公网开放（安全策略）

---

## ✅ 推荐解决方案：通过SSH隧道连接

### 方案优势
- ✅ 安全（通过SSH加密连接）
- ✅ 不需要开放MySQL 3306端口
- ✅ 使用现有数据库和数据
- ✅ 快速设置

### 步骤1：建立SSH隧道

打开一个**新的PowerShell或CMD窗口**，运行：

```bash
ssh -L 3307:localhost:3306 root@8.153.110.212
```

**解释**：
- `-L 3307:localhost:3306` - 将本地3307端口映射到服务器的3306端口
- 输入服务器密码后，保持这个窗口打开
- 这个窗口在运行期间会一直显示SSH会话

### 步骤2：修改.env配置

修改 `apps/web/.env` 文件：

```env
# 数据库配置 - 通过SSH隧道连接
DB_HOST=127.0.0.1
DB_PORT=3307
DB_USER=root
DB_PASSWORD=ChangeMe2026!Secure
DB_NAME=member_system
```

### 步骤3：重启Web应用

```bash
# 在项目目录运行
cd "C:\Users\yushu\Desktop\我的会员体系\apps\web"
pnpm dev
```

### 步骤4：测试

访问 http://localhost:3000 进行注册和登录

---

## 🔄 备选方案

### 方案A：使用本地MySQL（适合长期开发）

如果您计划经常本地开发，建议安装本地MySQL：

#### 1. 安装MySQL

下载：https://dev.mysql.com/downloads/mysql/

或使用XAMPP（包含MySQL）：https://www.apachefriends.org/

#### 2. 初始化数据库

```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE member_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 导入结构
mysql -u root -p member_system < apps/web/database-init-v3.sql
```

#### 3. 修改.env

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=你的本地MySQL密码
DB_NAME=member_system
```

### 方案B：开放远程MySQL访问（不推荐，安全风险）

**仅在必要时使用**，需要在服务器上执行：

```bash
# 1. SSH登录服务器
ssh root@8.153.110.212

# 2. 修改MySQL配置允许远程访问
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
# 找到 bind-address = 127.0.0.1
# 改为 bind-address = 0.0.0.0

# 3. 重启MySQL
sudo systemctl restart mysql

# 4. 授权远程访问
mysql -u root -p
```

```sql
GRANT ALL PRIVILEGES ON member_system.* TO 'root'@'%' IDENTIFIED BY 'ChangeMe2026!Secure';
FLUSH PRIVILEGES;
```

```bash
# 5. 开放防火墙
sudo ufw allow 3306/tcp
```

⚠️ **安全警告**: 这会让MySQL暴露在公网，有安全风险！

---

## 🎯 我的建议

### 现在（立即测试）
使用**SSH隧道方案** - 2分钟搞定

### 长期（正式开发）
安装**本地MySQL** - 开发更方便

### 生产环境
使用原有的远程数据库配置

---

## ⚡ 快速执行命令

### 使用SSH隧道（最快）

```powershell
# 窗口1: 建立SSH隧道（保持打开）
ssh -L 3307:localhost:3306 root@8.153.110.212

# 窗口2: 修改配置并启动
cd "C:\Users\yushu\Desktop\我的会员体系\apps\web"

# 修改.env中的 DB_HOST=127.0.0.1 和 DB_PORT=3307

pnpm dev
```

---

**选择建议**:
- ⏱️ 现在就想测试 → SSH隧道
- 🔧 准备长期开发 → 安装本地MySQL
- 🚀 只想快速看效果 → SSH隧道

需要我帮您执行哪个方案？
