# Nginx性能优化配置
# 将此配置添加到 /etc/nginx/nginx.conf 或站点配置文件

# 1. 启用Gzip压缩（立即生效，可减少70-80%传输大小）
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript
           application/json application/javascript application/xml+rss
           application/rss+xml font/truetype font/opentype
           application/vnd.ms-fontobject image/svg+xml;
gzip_min_length 256;

# 2. 启用Brotli压缩（比Gzip更高效，需要安装nginx-brotli模块）
# brotli on;
# brotli_comp_level 6;
# brotli_types text/plain text/css text/xml text/javascript
#              application/json application/javascript application/xml+rss;

# 3. 浏览器缓存配置
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

location ~* \.(html)$ {
    expires 1h;
    add_header Cache-Control "public, must-revalidate";
}

# 4. 静态资源缓存
location /_next/static/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

location /static/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# 5. 修复重定向问题（如果bk.yushuofupan.com应该直接访问）
server {
    listen 80;
    server_name bk.yushuofupan.com;

    # 直接代理到板块系统端口，不要重定向
    location / {
        proxy_pass http://localhost:3001;  # 假设板块系统运行在3001端口
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;

        # 增加超时时间
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
