# 切换时机建议

## 📋 目标

本文档帮助你判断何时可以安全地从member-system切换到apps/web作为主要生产环境。

---

## 🎯 切换的核心原则

### 三大原则
1. **稳定性优先**: 新系统必须比旧系统更稳定或至少同样稳定
2. **功能完整性**: 所有功能必须完全迁移和测试通过
3. **可回退性**: 必须有清晰的回滚方案

### 决策框架
```
是否切换 = 技术就绪 AND 业务就绪 AND 团队就绪 AND 时机合适
```

---

## ✅ 切换准备检查清单

### 1. 技术就绪度检查（必须全部通过）

#### 1.1 稳定性指标
```markdown
- [ ] apps/web连续运行超过2周无崩溃
- [ ] apps/web内存泄漏测试通过（24小时稳定）
- [ ] apps/web错误率 < 0.1%（与member-system对比）
- [ ] apps/web自动重启次数 = 0（过去1周）
```

#### 1.2 性能指标
```markdown
- [ ] 启动时间：apps/web <= member-system + 10%
- [ ] 内存占用：apps/web <= member-system + 20%
- [ ] API响应时间：apps/web <= member-system + 15%
- [ ] 首页加载时间：apps/web <= member-system + 10%
- [ ] 并发处理能力：apps/web >= member-system
```

#### 1.3 功能完整性
```markdown
- [ ] 用户注册功能正常
- [ ] 用户登录功能正常
- [ ] 会员升级功能正常
- [ ] 激活码系统正常
- [ ] 试用系统正常
- [ ] 管理员登录功能正常
- [ ] 会员管理功能正常（查看、编辑、冻结、删除）
- [ ] 激活码管理功能正常（生成、查询）
- [ ] 板块节奏系统正常
- [ ] 心理测评系统正常
- [ ] 复盘系统正常
- [ ] 数据统计正常
```

#### 1.4 兼容性检查
```markdown
- [ ] 数据库架构100%兼容
- [ ] 所有API端点响应格式一致
- [ ] JWT token跨系统兼容
- [ ] Cookie设置一致
- [ ] 环境变量完整迁移
```

#### 1.5 安全性检查
```markdown
- [ ] 认证机制正常工作
- [ ] 权限控制正确
- [ ] SQL注入防护有效
- [ ] XSS防护有效
- [ ] CSRF防护有效
- [ ] 密码加密正确
- [ ] 敏感数据加密
```

### 2. 业务就绪度检查

#### 2.1 数据准备
```markdown
- [ ] 生产数据库完整备份
- [ ] 备份验证成功（可恢复）
- [ ] 备份时间戳记录
- [ ] 数据迁移脚本准备（如需要）
- [ ] 数据一致性检查通过
```

#### 2.2 流量准备
```markdown
- [ ] 预估峰值流量可承受
- [ ] 并发用户数测试通过
- [ ] 流量激增场景测试
- [ ] CDN配置更新（如使用）
```

#### 2.3 监控准备
```markdown
- [ ] 应用监控配置完成
- [ ] 错误报警配置完成
- [ ] 性能监控配置完成
- [ ] 日志收集配置完成
- [ ] 通知渠道测试通过
```

### 3. 团队就绪度检查

#### 3.1 技能准备
```markdown
- [ ] 团队成员了解新架构
- [ ] 团队成员熟悉Monorepo工作流
- [ ] 团队成员了解pnpm使用
- [ ] 团队成员了解Turborepo
- [ ] 至少1人完全掌握新系统
```

#### 3.2 文档准备
```markdown
- [ ] 迁移文档完整
- [ ] 部署文档更新
- [ ] 故障排查文档准备
- [ ] 回滚文档准备
- [ ] 团队培训完成
```

#### 3.3 应急准备
```markdown
- [ ] 回滚方案测试通过
- [ ] 应急联系人确定
- [ ] 故障响应流程明确
- [ ] 备用方案准备
```

### 4. 时机选择检查

#### 4.1 业务时机
```markdown
- [ ] 非业务高峰期（如周末、夜间）
- [ ] 无重要活动或促销
- [ ] 无重大产品发布
- [ ] 有充足的监控时间（至少24小时）
```

#### 4.2 技术时机
```markdown
- [ ] 无其他重大变更
- [ ] 团队成员在线可支持
- [ ] 服务器资源充足
- [ ] 网络状况稳定
```

---

## 📊 切换决策矩阵

### 评分系统

每个类别满分100分，总分400分。

| 类别 | 满分 | 及格线 | 推荐线 |
|------|------|--------|--------|
| 技术就绪度 | 100 | 80 | 90 |
| 业务就绪度 | 100 | 75 | 85 |
| 团队就绪度 | 100 | 70 | 80 |
| 时机选择 | 100 | 60 | 80 |
| **总计** | **400** | **285** | **335** |

### 决策规则

```
总分 >= 335 分 + 每项 >= 推荐线  →  🟢 强烈建议切换
总分 >= 285 分 + 每项 >= 及格线  →  🟡 可以考虑切换
总分 < 285 分 或 任一项 < 及格线  →  🔴 不建议切换
```

### 评分详情

#### 技术就绪度（100分）
- 稳定性指标（30分）
  - 连续运行2周无崩溃：10分
  - 内存泄漏测试通过：10分
  - 错误率达标：10分

- 性能指标（30分）
  - 启动时间达标：6分
  - 内存占用达标：6分
  - API响应时间达标：6分
  - 首页加载时间达标：6分
  - 并发处理能力达标：6分

- 功能完整性（25分）
  - 核心功能全部通过：15分
  - 管理功能全部通过：10分

- 兼容性和安全性（15分）
  - 数据库兼容：5分
  - API兼容：5分
  - 安全检查通过：5分

#### 业务就绪度（100分）
- 数据准备（40分）
  - 数据库备份：20分
  - 备份验证：10分
  - 数据一致性：10分

- 流量准备（30分）
  - 并发测试：15分
  - 流量激增测试：15分

- 监控准备（30分）
  - 应用监控：10分
  - 错误报警：10分
  - 日志收集：10分

#### 团队就绪度（100分）
- 技能准备（40分）
  - 团队了解新架构：20分
  - 至少1人完全掌握：20分

- 文档准备（40分）
  - 迁移文档：10分
  - 部署文档：10分
  - 故障排查文档：10分
  - 回滚文档：10分

- 应急准备（20分）
  - 回滚测试：10分
  - 应急流程：10分

#### 时机选择（100分）
- 业务时机（50分）
  - 非高峰期：20分
  - 无重要活动：15分
  - 充足监控时间：15分

- 技术时机（50分）
  - 无其他变更：20分
  - 团队可支持：15分
  - 资源充足：15分

---

## 🚦 切换时机判断流程图

```
开始
  ↓
所有技术指标通过？
  ├─ 否 → 🔴 继续开发和测试
  └─ 是
      ↓
   业务就绪完成？
      ├─ 否 → 🔴 完成业务准备
      └─ 是
          ↓
       团队准备好？
          ├─ 否 → 🔴 进行培训和文档
          └─ 是
              ↓
           时机合适？
              ├─ 否 → 🟡 等待合适时机
              └─ 是
                  ↓
               🟢 可以切换
```

---

## 📅 推荐切换时间表

### 理想切换时间点

#### 每周维度
- **推荐**: 周六凌晨2:00-4:00（最低峰）
- **次选**: 周日晚上23:00-01:00
- **避免**: 周一到周五工作时间

#### 每月维度
- **推荐**: 月中（15-20号）
- **避免**: 月初（1-5号）、月末（26-31号）

#### 每年维度
- **推荐**: 1月、7月（淡季）
- **避免**: 11月、12月（年末）、春节前后

### 切换前准备时间

```
T-7天：完成所有技术测试
T-5天：完成团队培训
T-3天：完成备份和准备
T-1天：进行切换演练
T-0天：正式切换
T+1天：密集监控
T+7天：稳定性评估
```

---

## 🚨 不应该切换的信号

### 技术红线（任一出现立即停止）

```markdown
❌ apps/web出现随机崩溃（过去1周内）
❌ 功能测试失败率 > 5%
❌ 性能指标低于member-system 30%以上
❌ 数据库兼容性问题未解决
❌ 安全漏洞未修复
❌ 关键依赖版本冲突
```

### 业务红线

```markdown
❌ 即将有重要活动或促销
❌ 正在进行其他重大变更
❌ 用户投诉率上升
❌ 业务高峰期临近
❌ 数据库备份失败
```

### 团队红线

```markdown
❌ 核心成员不在岗
❌ 团队成员不熟悉新系统
❌ 缺少回滚方案
❌ 缺少故障响应流程
❌ 团队士气低落或压力过大
```

### 环境红线

```markdown
❌ 服务器资源不足（CPU/内存/磁盘）
❌ 网络不稳定
❌ 依赖服务不稳定（MySQL、Nginx等）
❌ 备份存储空间不足
```

---

## 📈 渐进式切换策略（推荐）

### 阶段1: 灰度切换（5%流量）

**时间**: 第1周
**范围**: 内部用户 + 少量外部用户

```markdown
配置:
- Nginx设置5%流量到apps/web（端口3001）
- 95%流量继续到member-system（端口3000）

监控指标:
- 错误率 < 0.1%
- 响应时间 < 500ms
- 用户投诉 = 0

通过标准:
- 连续7天无严重问题
- 性能指标正常
- 用户反馈良好
```

### 阶段2: 小规模切换（20%流量）

**时间**: 第2-3周
**范围**: 扩大到20%真实用户

```markdown
配置:
- Nginx设置20%流量到apps/web
- 80%流量继续到member-system

监控指标:
- 错误率 < 0.1%
- 响应时间 < 500ms
- 数据一致性检查

通过标准:
- 连续7天无严重问题
- 与member-system性能对比差异 < 10%
```

### 阶段3: 大规模切换（50%流量）

**时间**: 第4-5周
**范围**: 50%用户

```markdown
配置:
- Nginx设置50%流量到apps/web
- 50%流量继续到member-system

监控指标:
- 负载均衡效果
- 并发处理能力
- 系统稳定性

通过标准:
- 连续14天无严重问题
- 高峰期表现稳定
```

### 阶段4: 完全切换（100%流量）

**时间**: 第6周+
**范围**: 所有用户

```markdown
配置:
- Nginx设置100%流量到apps/web
- member-system作为热备（保持运行但不接受流量）

监控指标:
- 全量流量处理能力
- 系统各项指标
- 用户体验

通过标准:
- 连续30天无严重问题
- 用户满意度不下降
```

### 阶段5: 下线member-system

**时间**: 第10周+
**范围**: 完全迁移

```markdown
操作:
- 停止member-system PM2进程
- 保留member-system代码和配置（归档）
- 更新所有文档

保留期:
- 至少保留member-system 3个月
- 定期验证apps/web稳定性
- 确认无需回滚后，可归档删除
```

---

## 🎯 切换成功标准

### 短期成功标准（切换后1周）

```markdown
✅ 应用稳定运行，无崩溃
✅ 所有功能正常工作
✅ 性能指标达标
✅ 用户无明显投诉
✅ 团队适应新系统
```

### 中期成功标准（切换后1个月）

```markdown
✅ 错误率 < 0.1%
✅ 响应时间稳定
✅ 内存占用正常
✅ 无需回滚
✅ 团队完全掌握新系统
```

### 长期成功标准（切换后3个月）

```markdown
✅ 系统稳定性优于旧系统
✅ 维护成本降低
✅ 开发效率提升
✅ 可以安全下线member-system
✅ 为整合其他子系统做好准备
```

---

## 📋 切换前最终检查清单

### T-7天检查
```markdown
- [ ] 完成所有技术测试
- [ ] 性能测试报告生成
- [ ] 安全测试通过
- [ ] 备份策略确定
```

### T-3天检查
```markdown
- [ ] 生产数据库完整备份
- [ ] 备份验证成功
- [ ] 回滚脚本准备并测试
- [ ] 团队培训完成
- [ ] 监控和报警配置完成
```

### T-1天检查
```markdown
- [ ] 进行完整切换演练
- [ ] 确认所有团队成员就位
- [ ] 确认切换时间点
- [ ] 通知相关人员
- [ ] 准备应急联系方式
```

### T-0天检查（切换当天）
```markdown
- [ ] 再次备份数据库
- [ ] 确认服务器状态正常
- [ ] 确认网络状态稳定
- [ ] 团队成员在线待命
- [ ] 监控系统就绪
```

### T+0小时检查（切换后立即）
```markdown
- [ ] 访问首页正常
- [ ] 用户登录正常
- [ ] 核心功能测试通过
- [ ] PM2进程状态正常
- [ ] 查看日志无严重错误
```

### T+1小时检查
```markdown
- [ ] 监控指标正常
- [ ] 无异常报警
- [ ] 响应时间正常
- [ ] 内存占用正常
```

### T+24小时检查
```markdown
- [ ] 连续24小时无崩溃
- [ ] 用户反馈收集
- [ ] 性能数据分析
- [ ] 决定是否继续或回滚
```

---

## 🔄 切换决策树

```
开始评估切换时机
    ↓
技术就绪度 >= 90分？
    ├─ 否 → 继续开发测试 → 1个月后重新评估
    └─ 是
        ↓
    业务就绪度 >= 85分？
        ├─ 否 → 完成业务准备 → 2周后重新评估
        └─ 是
            ↓
        团队就绪度 >= 80分？
            ├─ 否 → 培训和文档 → 2周后重新评估
            └─ 是
                ↓
            时机选择 >= 80分？
                ├─ 否 → 等待合适时机 → 择期重新评估
                └─ 是
                    ↓
                选择切换策略：
                    ├─ 保守 → 渐进式切换（5周）
                    ├─ 稳健 → 渐进式切换（3周）
                    └─ 激进 → 一次性切换（风险高，不推荐）
                        ↓
                    执行切换
                        ↓
                    持续监控
                        ↓
                    评估成功标准
                        ├─ 通过 → 继续运行 → 最终下线member-system
                        └─ 未通过 → 立即回滚 → 分析原因 → 重新准备
```

---

## 💡 建议和最佳实践

### 保守策略（强烈推荐）

1. **不要急于切换**
   - apps/web至少稳定运行3个月
   - 经历至少1-2次业务高峰
   - 团队完全熟悉新系统

2. **采用渐进式切换**
   - 从5%流量开始
   - 逐步增加到100%
   - 每个阶段充分验证

3. **保留回滚能力**
   - member-system至少保留3个月
   - 随时可以快速回滚
   - 定期测试回滚流程

### 监控重点

1. **关键指标**
   - 错误率（目标: < 0.1%）
   - 响应时间（目标: < 500ms）
   - 内存占用（目标: < 1GB）
   - CPU使用率（目标: < 60%）

2. **用户体验**
   - 页面加载时间
   - API响应速度
   - 功能可用性
   - 用户投诉数

3. **业务指标**
   - 注册转化率
   - 登录成功率
   - 支付成功率
   - 活跃用户数

---

## 📞 应急联系和支持

### 切换过程中遇到问题

1. **立即评估严重程度**
   - 严重: 影响核心功能 → 立即回滚
   - 中等: 影响部分功能 → 快速修复或回滚
   - 轻微: 不影响主要功能 → 记录并择期修复

2. **回滚决策**
   - 参考回滚方案文档
   - 5分钟内完成回滚
   - 恢复member-system服务

3. **问题分析**
   - 收集日志和错误信息
   - 分析根本原因
   - 制定修复方案
   - 重新准备切换

---

## 📚 相关文档

- [渐进式迁移计划](./PROGRESSIVE-MIGRATION-PLAN.md)
- [双轨运行指南](./DUAL-TRACK-GUIDE.md)
- [回滚方案](./ROLLBACK-PLAN.md)

---

**最后更新**: 2026-01-24
**文档版本**: v1.0
**适用范围**: member-system → apps/web 切换
