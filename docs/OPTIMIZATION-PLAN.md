# ğŸš€ å¾¡æœ”å¤ç›˜ä¼šå‘˜ç³»ç»Ÿ - æ·±åº¦ä¼˜åŒ–æ–¹æ¡ˆ

**åˆ†ææ—¶é—´**: 2026-01-04
**å½“å‰ç‰ˆæœ¬**: v1.0
**ä¼˜åŒ–ç›®æ ‡**: ä¼ä¸šçº§ä¼šå‘˜ç®¡ç†ç³»ç»Ÿ

---

## ğŸ“Š ç³»ç»Ÿç°çŠ¶åˆ†æ

### âœ… å½“å‰ä¼˜åŠ¿
1. âœ… å®Œæ•´çš„åŸºç¡€åŠŸèƒ½ï¼ˆæ³¨å†Œã€ç™»å½•ã€æ¿€æ´»ç ã€ä¼šå‘˜ç®¡ç†ï¼‰
2. âœ… ç°ä»£åŒ–æŠ€æœ¯æ ˆï¼ˆNext.js 14 + TypeScript + MySQLï¼‰
3. âœ… Apple é£æ ¼è®¾è®¡ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½
4. âœ… åŸºç¡€çš„å®‰å…¨æªæ–½ï¼ˆbcrypt åŠ å¯†ã€JWT è®¤è¯ï¼‰
5. âœ… PM2 è¿›ç¨‹ç®¡ç†ï¼ŒNginx åå‘ä»£ç†

### âš ï¸ å…³é”®é—®é¢˜å’Œä¼˜åŒ–ç©ºé—´

#### ğŸ” å®‰å…¨æ€§é—®é¢˜ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
1. **æƒé™éªŒè¯ä»…åœ¨å‰ç«¯** - ç”¨æˆ·å¯ä»¥é€šè¿‡ç›´æ¥è®¿é—® URL ç»•è¿‡æƒé™æ£€æŸ¥
2. **ç¼ºå°‘ API å±‚æƒé™éªŒè¯** - åç«¯ API æ²¡æœ‰ç»Ÿä¸€çš„æƒé™ä¸­é—´ä»¶
3. **JWT Token ç®¡ç†ä¸å®Œå–„** - ç¼ºå°‘åˆ·æ–°æœºåˆ¶ï¼Œtoken è¿‡æœŸåç”¨æˆ·ä½“éªŒå·®
4. **ç™»å½•å¤±è´¥é™åˆ¶ç¼ºå¤±** - å®¹æ˜“è¢«æš´åŠ›ç ´è§£
5. **ç®¡ç†å‘˜æ“ä½œæ— å®¡è®¡** - æ— æ³•è¿½æº¯è°åšäº†ä»€ä¹ˆæ“ä½œ

#### ğŸ¯ è®¿é—®æ§åˆ¶é€»è¾‘é—®é¢˜ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
1. **äº§å“è®¿é—®æ— æ—¥å¿—** - ä¸çŸ¥é“ç”¨æˆ·ä½•æ—¶è®¿é—®äº†å“ªä¸ªäº§å“
2. **ç¼ºå°‘é˜²æ»¥ç”¨æœºåˆ¶** - åŒä¸€è´¦å·å¯ä»¥æ— é™åˆ¶åˆ†äº«ç»™ä»–äºº
3. **è¿‡æœŸæ£€æŸ¥ä¸å®æ—¶** - ä»…åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ï¼Œç”¨æˆ·å¯èƒ½åœ¨ä¼šå‘˜è¿‡æœŸåç»§ç»­ä½¿ç”¨
4. **è®¿é—®æƒé™æ£€æŸ¥åˆ†æ•£** - æ¯ä¸ªé¡µé¢éƒ½è¦é‡å¤æ£€æŸ¥é€»è¾‘

#### ğŸ“ˆ åå°ç®¡ç†é—®é¢˜ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
1. **æ•°æ®ç»Ÿè®¡å•è–„** - ç¼ºå°‘è¶‹åŠ¿åˆ†æã€å¢é•¿æ›²çº¿
2. **æ— æ‰¹é‡æ“ä½œ** - æ— æ³•æ‰¹é‡è°ƒæ•´ä¼šå‘˜ã€æ‰¹é‡æ’¤é”€æ¿€æ´»ç 
3. **ç¼ºå°‘æ•°æ®å¯¼å‡º** - æ— æ³•å¯¼å‡ºç”¨æˆ·åˆ—è¡¨ã€æ¿€æ´»ç åˆ—è¡¨
4. **æ“ä½œæ•ˆç‡ä½** - æ¯æ¬¡æ“ä½œéƒ½è¦æ‰‹åŠ¨è¾“å…¥ï¼Œç¼ºå°‘å¿«æ·æ“ä½œ

#### ğŸ’¡ ç”¨æˆ·ä½“éªŒé—®é¢˜ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
1. **æ— åˆ°æœŸæé†’** - ç”¨æˆ·ä¸çŸ¥é“ä¼šå‘˜ä½•æ—¶åˆ°æœŸ
2. **æ— ç»­è´¹åŠŸèƒ½** - åˆ°æœŸååªèƒ½é‡æ–°æ¿€æ´»
3. **æ— ä¼˜æƒ åˆ¸ç³»ç»Ÿ** - æ— æ³•è¿›è¡Œè¥é”€æ´»åŠ¨
4. **é”™è¯¯æç¤ºä¸å‹å¥½** - æŠ€æœ¯æ€§é”™è¯¯ä¿¡æ¯ç›´æ¥å±•ç¤ºç»™ç”¨æˆ·

#### âš¡ æ€§èƒ½é—®é¢˜ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
1. **æ— ç¼“å­˜æœºåˆ¶** - æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
2. **æ•°æ®åº“æŸ¥è¯¢æœªä¼˜åŒ–** - ç¼ºå°‘å¤åˆç´¢å¼•
3. **é™æ€èµ„æºæœª CDN** - åŠ è½½é€Ÿåº¦å¯ä¼˜åŒ–

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### ğŸ”¥ Phase 1: æ ¸å¿ƒå®‰å…¨å’Œè®¿é—®æ§åˆ¶ä¼˜åŒ–ï¼ˆç«‹å³å®æ–½ï¼‰

#### 1.1 æœåŠ¡å™¨ç«¯æƒé™éªŒè¯ä¸­é—´ä»¶

**é—®é¢˜**: å½“å‰æƒé™æ£€æŸ¥ä¸»è¦åœ¨å‰ç«¯ï¼Œç”¨æˆ·å¯ä»¥ç»•è¿‡

**è§£å†³æ–¹æ¡ˆ**: åˆ›å»ºç»Ÿä¸€çš„æƒé™éªŒè¯ä¸­é—´ä»¶

```typescript
// lib/auth-guard.ts
export async function requireAuth(request: NextRequest) {
  const token = request.cookies.get('auth_token')?.value;
  if (!token) throw new UnauthorizedError();

  const user = await verifyToken(token);
  return user;
}

export async function requireMembership(
  request: NextRequest,
  requiredLevel: MembershipLevel
) {
  const user = await requireAuth(request);

  // æ£€æŸ¥ä¼šå‘˜ç­‰çº§
  if (!hasAccess(user.membershipLevel, requiredLevel)) {
    throw new ForbiddenError('ä¼šå‘˜ç­‰çº§ä¸è¶³');
  }

  // æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆå®æ—¶æ£€æŸ¥ï¼‰
  if (user.expiresAt && new Date(user.expiresAt) < new Date()) {
    throw new ForbiddenError('ä¼šå‘˜å·²è¿‡æœŸ');
  }

  return user;
}
```

**åº”ç”¨ä½ç½®**: æ‰€æœ‰ API è·¯ç”±ã€äº§å“è®¿é—®ç«¯ç‚¹

**æ”¶ç›Š**:
- âœ… é˜²æ­¢å‰ç«¯ç»•è¿‡æƒé™æ£€æŸ¥
- âœ… å®æ—¶éªŒè¯ä¼šå‘˜çŠ¶æ€
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†

---

#### 1.2 äº§å“è®¿é—®æ—¥å¿—ç³»ç»Ÿ

**é—®é¢˜**: æ— æ³•è¿½è¸ªç”¨æˆ·è®¿é—®è¡Œä¸ºï¼Œæ— æ³•å‘ç°å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**: è®°å½•æ‰€æœ‰äº§å“è®¿é—®

**æ•°æ®åº“è¡¨è®¾è®¡**:
```sql
CREATE TABLE product_access_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  product_slug VARCHAR(50) NOT NULL,
  access_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  ip_address VARCHAR(45),
  user_agent TEXT,
  session_id VARCHAR(100),
  INDEX idx_user_product (user_id, product_slug),
  INDEX idx_access_time (access_time),
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**åŠŸèƒ½**:
- è®°å½•æ¯æ¬¡äº§å“è®¿é—®
- æ£€æµ‹å¼‚å¸¸è®¿é—®æ¨¡å¼ï¼ˆå¦‚çŸ­æ—¶é—´å†…å¤šIPè®¿é—®ï¼‰
- ç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦
- ä¸ºæ•°æ®åˆ†ææä¾›åŸºç¡€

**API ç«¯ç‚¹**:
```typescript
// api/products/access/[slug]/route.ts
export async function GET(request: NextRequest, { params }) {
  const user = await requireMembership(request, getProductLevel(params.slug));

  // è®°å½•è®¿é—®æ—¥å¿—
  await logProductAccess({
    userId: user.id,
    productSlug: params.slug,
    ipAddress: request.ip,
    userAgent: request.headers.get('user-agent'),
  });

  // æ£€æµ‹å¼‚å¸¸è®¿é—®
  const recentAccesses = await getRecentAccesses(user.id, params.slug, 1); // 1å°æ—¶å†…
  if (recentAccesses.length > 10) {
    await notifyAdmin(`ç”¨æˆ· ${user.email} é¢‘ç¹è®¿é—® ${params.slug}`);
  }

  // è¿”å›äº§å“URL
  return NextResponse.json({ url: getProductUrl(params.slug) });
}
```

**æ”¶ç›Š**:
- âœ… è¿½è¸ªç”¨æˆ·è¡Œä¸º
- âœ… æ£€æµ‹è´¦å·åˆ†äº«/æ»¥ç”¨
- âœ… æ•°æ®åˆ†æåŸºç¡€
- âœ… å¼‚å¸¸é¢„è­¦

---

#### 1.3 JWT Token åˆ·æ–°æœºåˆ¶

**é—®é¢˜**: Token è¿‡æœŸåç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ï¼Œä½“éªŒå·®

**è§£å†³æ–¹æ¡ˆ**: å®ç° Access Token + Refresh Token åŒ Token æœºåˆ¶

```typescript
// lib/token.ts
export function generateTokens(userId: number) {
  const accessToken = jwt.sign(
    { userId, type: 'access' },
    process.env.JWT_SECRET!,
    { expiresIn: '15m' } // çŸ­æœŸ token
  );

  const refreshToken = jwt.sign(
    { userId, type: 'refresh' },
    process.env.JWT_REFRESH_SECRET!,
    { expiresIn: '7d' } // é•¿æœŸ token
  );

  return { accessToken, refreshToken };
}

// api/auth/refresh/route.ts
export async function POST(request: NextRequest) {
  const refreshToken = request.cookies.get('refresh_token')?.value;

  const payload = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET!);
  if (payload.type !== 'refresh') throw new Error('Invalid token type');

  const { accessToken, refreshToken: newRefreshToken } = generateTokens(payload.userId);

  return NextResponse.json({ accessToken }, {
    headers: {
      'Set-Cookie': `refresh_token=${newRefreshToken}; HttpOnly; Secure; Path=/; Max-Age=604800`,
    }
  });
}
```

**å‰ç«¯è‡ªåŠ¨åˆ·æ–°**:
```typescript
// lib/api-client.ts
async function fetchWithAuth(url: string, options: RequestInit) {
  let response = await fetch(url, options);

  // Token è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°
  if (response.status === 401) {
    await fetch('/api/auth/refresh', { method: 'POST' });
    response = await fetch(url, options); // é‡è¯•
  }

  return response;
}
```

**æ”¶ç›Š**:
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ç»­æœŸ
- âœ… æå‡å®‰å…¨æ€§ï¼ˆçŸ­æœŸ token æ³„éœ²é£é™©ä½ï¼‰
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

#### 1.4 ç™»å½•å¤±è´¥é™åˆ¶

**é—®é¢˜**: å®¹æ˜“è¢«æš´åŠ›ç ´è§£

**è§£å†³æ–¹æ¡ˆ**: IP + è´¦å·åŒé‡é™æµ

```typescript
// lib/login-limiter.ts
const loginAttempts = new Map<string, { count: number; lockUntil: Date }>();

export async function checkLoginLimit(email: string, ip: string) {
  const key = `${email}:${ip}`;
  const attempt = loginAttempts.get(key);

  if (attempt && attempt.lockUntil > new Date()) {
    const remainingMinutes = Math.ceil((attempt.lockUntil.getTime() - Date.now()) / 60000);
    throw new Error(`ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯· ${remainingMinutes} åˆ†é’Ÿåé‡è¯•`);
  }

  return true;
}

export async function recordLoginFailure(email: string, ip: string) {
  const key = `${email}:${ip}`;
  const attempt = loginAttempts.get(key) || { count: 0, lockUntil: new Date() };

  attempt.count += 1;

  // 5æ¬¡å¤±è´¥é”å®š30åˆ†é’Ÿ
  if (attempt.count >= 5) {
    attempt.lockUntil = new Date(Date.now() + 30 * 60 * 1000);
  }

  loginAttempts.set(key, attempt);
}

export async function clearLoginAttempts(email: string, ip: string) {
  loginAttempts.delete(`${email}:${ip}`);
}
```

**æ”¶ç›Š**:
- âœ… é˜²æ­¢æš´åŠ›ç ´è§£
- âœ… æå‡è´¦å·å®‰å…¨

---

#### 1.5 ç®¡ç†å‘˜æ“ä½œå®¡è®¡

**é—®é¢˜**: æ— æ³•è¿½è¸ªç®¡ç†å‘˜æ“ä½œï¼Œå‡ºé—®é¢˜éš¾ä»¥å®šä½

**è§£å†³æ–¹æ¡ˆ**: è®°å½•æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œ

**æ•°æ®åº“è¡¨**:
```sql
CREATE TABLE admin_audit_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  admin_id INT NOT NULL,
  action VARCHAR(100) NOT NULL,
  target_type VARCHAR(50),
  target_id INT,
  old_value JSON,
  new_value JSON,
  ip_address VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_admin_action (admin_id, action),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (admin_id) REFERENCES admins(id)
);
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
// api/admin/members/[id]/adjust/route.ts
export async function POST(request: NextRequest, { params }) {
  const admin = await requireAdmin(request);
  const { level, expiresAt } = await request.json();

  // è·å–æ—§å€¼
  const oldMembership = await getMembership(params.id);

  // æ‰§è¡Œæ“ä½œ
  await updateMembership(params.id, { level, expiresAt });

  // è®°å½•å®¡è®¡æ—¥å¿—
  await createAuditLog({
    adminId: admin.id,
    action: 'adjust_membership',
    targetType: 'membership',
    targetId: params.id,
    oldValue: oldMembership,
    newValue: { level, expiresAt },
    ipAddress: request.ip,
  });

  return NextResponse.json({ success: true });
}
```

**åå°æŸ¥çœ‹ç•Œé¢** (`/admin/audit-logs`):
- æ˜¾ç¤ºæ‰€æœ‰æ“ä½œè®°å½•
- ç­›é€‰ï¼ˆæŒ‰ç®¡ç†å‘˜ã€æ“ä½œç±»å‹ã€æ—¶é—´ï¼‰
- å¯¼å‡ºå®¡è®¡æŠ¥å‘Š

**æ”¶ç›Š**:
- âœ… æ“ä½œå¯è¿½æº¯
- âœ… è´£ä»»æ˜ç¡®
- âœ… åˆè§„å®¡è®¡
- âœ… é—®é¢˜å®šä½

---

### ğŸš€ Phase 2: åå°ç®¡ç†å¢å¼ºï¼ˆæœ¬å‘¨å®Œæˆï¼‰

#### 2.1 æ•°æ®ç»Ÿè®¡ä¼˜åŒ–

**å½“å‰**: åªæœ‰åŸºç¡€çš„æ•°é‡ç»Ÿè®¡

**ä¼˜åŒ–**: æ·»åŠ è¶‹åŠ¿åˆ†æå’Œå¯è§†åŒ–

**æ–°å¢æŒ‡æ ‡**:
1. **ç”¨æˆ·å¢é•¿è¶‹åŠ¿** - æ¯æ—¥æ–°æ³¨å†Œç”¨æˆ·æ•°
2. **ä¼šå‘˜è½¬åŒ–ç‡** - æ³¨å†Œç”¨æˆ· â†’ ä»˜è´¹ä¼šå‘˜æ¯”ä¾‹
3. **ä¼šå‘˜ç•™å­˜ç‡** - 30å¤©/90å¤©/365å¤©ç•™å­˜
4. **æ¿€æ´»ç ä½¿ç”¨ç‡** - å·²ç”Ÿæˆ vs å·²ä½¿ç”¨
5. **äº§å“è®¿é—®çƒ­åº¦** - å„äº§å“è®¿é—®æ¬¡æ•°æ’å
6. **æ”¶å…¥é¢„æµ‹** - åŸºäºå½“å‰ä¼šå‘˜ç»­è´¹é¢„æµ‹æœªæ¥æ”¶å…¥

**å®ç°**:
```typescript
// api/admin/dashboard/analytics/route.ts
export async function GET(request: NextRequest) {
  const { timeRange = '30d' } = getQueryParams(request);

  const analytics = {
    userGrowth: await getUserGrowthTrend(timeRange),
    conversionRate: await getConversionRate(timeRange),
    retention: await getRetentionRate(timeRange),
    activationRate: await getActivationCodeUsage(timeRange),
    productPopularity: await getProductAccessRanking(timeRange),
    revenueProjection: await getRevenueProjection(timeRange),
  };

  return NextResponse.json(analytics);
}
```

**å‰ç«¯å±•ç¤º**: ä½¿ç”¨ Chart.js æˆ– Recharts ç»˜åˆ¶å›¾è¡¨

**æ”¶ç›Š**:
- âœ… æ•°æ®é©±åŠ¨å†³ç­–
- âœ… å‘ç°ä¸šåŠ¡é—®é¢˜
- âœ… ä¼˜åŒ–è¿è¥ç­–ç•¥

---

#### 2.2 æ‰¹é‡æ“ä½œåŠŸèƒ½

**æ–°å¢åŠŸèƒ½**:

1. **æ‰¹é‡ç”Ÿæˆæ¿€æ´»ç **
   - æ”¯æŒä¸€æ¬¡ç”Ÿæˆ 1-1000 ä¸ª
   - è‡ªåŠ¨ç¼–å·
   - æ‰¹é‡å¯¼å‡ºä¸º Excel/CSV

2. **æ‰¹é‡è°ƒæ•´ä¼šå‘˜**
   - å‹¾é€‰å¤šä¸ªç”¨æˆ·
   - ç»Ÿä¸€è°ƒæ•´ç­‰çº§æˆ–å»¶é•¿æ—¶é—´
   - ç¡®è®¤åæ‰¹é‡æ‰§è¡Œ

3. **æ‰¹é‡æ’¤é”€æ¿€æ´»ç **
   - ç­›é€‰æœªä½¿ç”¨çš„æ¿€æ´»ç 
   - æ‰¹é‡ä½œåºŸ
   - é˜²æ­¢æ¿€æ´»ç æ³„éœ²

**å®ç°ç¤ºä¾‹**:
```typescript
// api/admin/codes/bulk-generate/route.ts
export async function POST(request: NextRequest) {
  const admin = await requireAdmin(request);
  const { level, count, prefix } = await request.json();

  if (count > 1000) throw new Error('å•æ¬¡æœ€å¤šç”Ÿæˆ1000ä¸ª');

  const codes = [];
  for (let i = 0; i < count; i++) {
    const code = await generateActivationCode({
      level,
      adminId: admin.id,
      batch: `${prefix}-${Date.now()}`,
    });
    codes.push(code);
  }

  // è®°å½•å®¡è®¡æ—¥å¿—
  await createAuditLog({
    adminId: admin.id,
    action: 'bulk_generate_codes',
    targetType: 'activation_code',
    newValue: { level, count },
  });

  return NextResponse.json({ codes });
}
```

**æ”¶ç›Š**:
- âœ… æå‡æ“ä½œæ•ˆç‡
- âœ… å‡å°‘äººå·¥é”™è¯¯
- âœ… æ”¯æŒå¤§è§„æ¨¡è¿è¥

---

#### 2.3 æ•°æ®å¯¼å‡ºåŠŸèƒ½

**æ”¯æŒå¯¼å‡º**:
1. ç”¨æˆ·åˆ—è¡¨ï¼ˆExcel/CSVï¼‰
2. æ¿€æ´»ç åˆ—è¡¨ï¼ˆå«ä½¿ç”¨çŠ¶æ€ï¼‰
3. å®¡è®¡æ—¥å¿—
4. è®¿é—®æ—¥å¿—
5. ç»Ÿè®¡æŠ¥è¡¨

**å®ç°**:
```typescript
// lib/export.ts
import * as XLSX from 'xlsx';

export async function exportToExcel(data: any[], filename: string) {
  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');

  const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });

  return new NextResponse(buffer, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'Content-Disposition': `attachment; filename="${filename}.xlsx"`,
    },
  });
}

// api/admin/export/members/route.ts
export async function GET(request: NextRequest) {
  const admin = await requireAdmin(request);

  const members = await db.query(`
    SELECT
      u.id, u.email, u.created_at,
      m.level, m.expires_at,
      CASE
        WHEN m.expires_at IS NULL THEN 'lifetime'
        WHEN m.expires_at < NOW() THEN 'expired'
        ELSE 'active'
      END as status
    FROM users u
    LEFT JOIN memberships m ON u.id = m.user_id
    ORDER BY u.created_at DESC
  `);

  return exportToExcel(members, `members-${Date.now()}`);
}
```

**æ”¶ç›Š**:
- âœ… æ•°æ®å¤‡ä»½
- âœ… ç¦»çº¿åˆ†æ
- âœ… æŠ¥è¡¨ç”Ÿæˆ

---

### ğŸ’ Phase 3: ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆä¸‹å‘¨å®Œæˆï¼‰

#### 3.1 ä¼šå‘˜åˆ°æœŸæé†’

**å®ç°æ–¹å¼**: å®šæ—¶ä»»åŠ¡ + ç«™å†…é€šçŸ¥

**æé†’æ—¶æœº**:
- åˆ°æœŸå‰ 7 å¤©
- åˆ°æœŸå‰ 3 å¤©
- åˆ°æœŸå‰ 1 å¤©
- åˆ°æœŸå½“å¤©

**å®ç°**:
```typescript
// scripts/check-expiring-memberships.ts
export async function checkExpiringMemberships() {
  const expiringUsers = await db.query(`
    SELECT u.id, u.email, m.expires_at, m.level
    FROM users u
    JOIN memberships m ON u.id = m.user_id
    WHERE m.expires_at BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 7 DAY)
    AND m.expires_at IS NOT NULL
  `);

  for (const user of expiringUsers) {
    const daysLeft = Math.ceil((user.expires_at - Date.now()) / (1000 * 60 * 60 * 24));

    // å‘é€ç«™å†…é€šçŸ¥
    await createNotification({
      userId: user.id,
      type: 'membership_expiring',
      title: 'ä¼šå‘˜å³å°†åˆ°æœŸ',
      content: `æ‚¨çš„${user.level}ä¼šå‘˜å°†åœ¨${daysLeft}å¤©ååˆ°æœŸï¼Œè¯·åŠæ—¶ç»­è´¹`,
    });

    // TODO: å‘é€é‚®ä»¶é€šçŸ¥
  }
}

// åœ¨ PM2 ä¸­é…ç½®å®šæ—¶ä»»åŠ¡
// ecosystem.config.js
{
  name: 'membership-checker',
  script: 'node_modules/.bin/ts-node',
  args: 'scripts/check-expiring-memberships.ts',
  cron_restart: '0 9 * * *', // æ¯å¤©æ—©ä¸Š9ç‚¹æ‰§è¡Œ
}
```

**å‰ç«¯å±•ç¤º**:
- ä¼šå‘˜ä¸­å¿ƒé¡¶éƒ¨æ˜¾ç¤ºåˆ°æœŸæé†’
- å¯¼èˆªæ æ˜¾ç¤ºé€šçŸ¥å°çº¢ç‚¹

**æ”¶ç›Š**:
- âœ… æå‡ç»­è´¹ç‡
- âœ… é™ä½æµå¤±
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

#### 3.2 ä¼šå‘˜ç»­è´¹åŠŸèƒ½

**é—®é¢˜**: å½“å‰åˆ°æœŸååªèƒ½é‡æ–°æ¿€æ´»ï¼Œä¸å¤Ÿçµæ´»

**è§£å†³æ–¹æ¡ˆ**: å¢åŠ ç»­è´¹é€‰é¡¹

**å®ç°**:
```typescript
// api/activation/renew/route.ts
export async function POST(request: NextRequest) {
  const user = await requireAuth(request);
  const { code } = await request.json();

  const activation = await getActivationCode(code);
  if (!activation || activation.used) {
    throw new Error('æ¿€æ´»ç æ— æ•ˆæˆ–å·²ä½¿ç”¨');
  }

  const currentMembership = await getMembership(user.id);

  // å¦‚æœæœªè¿‡æœŸï¼Œåœ¨å½“å‰åˆ°æœŸæ—¶é—´åŸºç¡€ä¸Šå»¶é•¿
  // å¦‚æœå·²è¿‡æœŸï¼Œä»ç°åœ¨å¼€å§‹è®¡ç®—
  const baseDate = currentMembership.expiresAt > new Date()
    ? currentMembership.expiresAt
    : new Date();

  const newExpiresAt = addDays(baseDate, getLevelDuration(activation.level));

  await updateMembership(user.id, {
    level: activation.level,
    expiresAt: newExpiresAt,
  });

  await markCodeAsUsed(code, user.id);

  return NextResponse.json({
    success: true,
    expiresAt: newExpiresAt,
  });
}
```

**UI ä¼˜åŒ–**:
- åˆ°æœŸå‰æ˜¾ç¤º"ç»­è´¹"æŒ‰é’®
- ç»­è´¹æ—¶è‡ªåŠ¨å»¶é•¿ï¼Œä¸æ˜¯è¦†ç›–

**æ”¶ç›Š**:
- âœ… æå‡ç»­è´¹ä¾¿åˆ©æ€§
- âœ… é˜²æ­¢ç”¨æˆ·æµå¤±
- âœ… æ›´åˆç†çš„æ—¶é•¿è®¡ç®—

---

#### 3.3 ä¼˜æƒ åˆ¸ç³»ç»Ÿ

**åŠŸèƒ½**:
- ç®¡ç†å‘˜åˆ›å»ºä¼˜æƒ åˆ¸
- æ”¯æŒæŠ˜æ‰£ç ï¼ˆå¦‚ SPRING2026ï¼‰
- é™åˆ¶ä½¿ç”¨æ¬¡æ•°
- è®¾ç½®æœ‰æ•ˆæœŸ

**æ•°æ®åº“è¡¨**:
```sql
CREATE TABLE discount_coupons (
  id INT AUTO_INCREMENT PRIMARY KEY,
  code VARCHAR(50) UNIQUE NOT NULL,
  discount_type ENUM('percentage', 'fixed') NOT NULL,
  discount_value DECIMAL(10,2) NOT NULL,
  min_level ENUM('none', 'monthly', 'quarterly', 'yearly', 'lifetime'),
  max_uses INT DEFAULT NULL,
  used_count INT DEFAULT 0,
  valid_from DATE,
  valid_until DATE,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_code (code)
);

CREATE TABLE coupon_usage_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  coupon_id INT NOT NULL,
  user_id INT NOT NULL,
  used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (coupon_id) REFERENCES discount_coupons(id),
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**ä½¿ç”¨æµç¨‹**:
1. ç®¡ç†å‘˜åˆ›å»ºä¼˜æƒ åˆ¸
2. ç”¨æˆ·åœ¨æ¿€æ´»æ—¶è¾“å…¥ä¼˜æƒ ç 
3. ç³»ç»ŸéªŒè¯å¹¶åº”ç”¨æŠ˜æ‰£
4. è®°å½•ä½¿ç”¨æ—¥å¿—

**æ”¶ç›Š**:
- âœ… è¥é”€æ´»åŠ¨æ”¯æŒ
- âœ… æå‡è½¬åŒ–ç‡
- âœ… çµæ´»çš„å®šä»·ç­–ç•¥

---

### âš¡ Phase 4: æ€§èƒ½ä¼˜åŒ–ï¼ˆæŒç»­è¿›è¡Œï¼‰

#### 4.1 Redis ç¼“å­˜

**ç¼“å­˜å†…å®¹**:
1. ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯ï¼ˆæœ‰æ•ˆæœŸ1å°æ—¶ï¼‰
2. äº§å“é…ç½®ï¼ˆæœ‰æ•ˆæœŸ24å°æ—¶ï¼‰
3. ç»Ÿè®¡æ•°æ®ï¼ˆæœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼‰

**å®ç°**:
```typescript
// lib/cache.ts
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

export async function getCached<T>(
  key: string,
  fetcher: () => Promise<T>,
  ttl: number = 3600
): Promise<T> {
  const cached = await redis.get(key);
  if (cached) return JSON.parse(cached);

  const data = await fetcher();
  await redis.setex(key, ttl, JSON.stringify(data));

  return data;
}

// ä½¿ç”¨ç¤ºä¾‹
const membership = await getCached(
  `membership:${userId}`,
  () => getMembershipFromDB(userId),
  3600
);
```

**æ”¶ç›Š**:
- âœ… å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- âœ… æå‡å“åº”é€Ÿåº¦
- âœ… é™ä½æœåŠ¡å™¨è´Ÿè½½

---

#### 4.2 æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•ä¼˜åŒ–**:
```sql
-- ç”¨æˆ·æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_user_created ON users(created_at);

-- ä¼šå‘˜æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_membership_user ON memberships(user_id);
CREATE INDEX idx_membership_expires ON memberships(expires_at);
CREATE INDEX idx_membership_level_expires ON memberships(level, expires_at);

-- æ¿€æ´»ç æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_code_value ON activation_codes(code);
CREATE INDEX idx_code_used ON activation_codes(used, level);
CREATE INDEX idx_code_admin ON activation_codes(admin_id, created_at);
```

**æŸ¥è¯¢ä¼˜åŒ–**:
```sql
-- ä¼˜åŒ–å‰ï¼ˆæ…¢æŸ¥è¯¢ï¼‰
SELECT * FROM users
LEFT JOIN memberships ON users.id = memberships.user_id
WHERE memberships.expires_at > NOW();

-- ä¼˜åŒ–å
SELECT u.id, u.email, m.level, m.expires_at
FROM users u
INNER JOIN memberships m ON u.id = m.user_id
WHERE m.expires_at > NOW()
  AND m.level != 'none'
USE INDEX (idx_membership_level_expires);
```

**æ”¶ç›Š**:
- âœ… æŸ¥è¯¢é€Ÿåº¦æå‡ 10-100å€
- âœ… æ”¯æŒæ›´å¤§ç”¨æˆ·é‡
- âœ… é™ä½ CPU å ç”¨

---

## ğŸ› ï¸ å®æ–½è®¡åˆ’

### ç¬¬1å¤©ï¼ˆä»Šæ™š-æ˜å¤©ï¼‰
- [x] å®Œæˆä¼˜åŒ–æ–¹æ¡ˆæ–‡æ¡£
- [ ] å®ç°æœåŠ¡å™¨ç«¯æƒé™éªŒè¯ä¸­é—´ä»¶
- [ ] æ·»åŠ äº§å“è®¿é—®æ—¥å¿—ç³»ç»Ÿ
- [ ] å®ç°ç™»å½•å¤±è´¥é™åˆ¶
- [ ] æ¨é€ä»£ç å¹¶è‡ªåŠ¨éƒ¨ç½²

### ç¬¬2-3å¤©
- [ ] å®ç°ç®¡ç†å‘˜æ“ä½œå®¡è®¡
- [ ] æ·»åŠ æ‰¹é‡æ“ä½œåŠŸèƒ½
- [ ] å®ç°æ•°æ®å¯¼å‡º

### ç¬¬4-5å¤©
- [ ] å®ç°ä¼šå‘˜åˆ°æœŸæé†’
- [ ] æ·»åŠ ç»­è´¹åŠŸèƒ½
- [ ] ä¼˜åŒ–æ•°æ®ç»Ÿè®¡

### ç¬¬6-7å¤©
- [ ] éƒ¨ç½² Redis
- [ ] å®ç°ç¼“å­˜æœºåˆ¶
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] æ€§èƒ½æµ‹è¯•

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### å®‰å…¨æ€§æå‡
- âœ… é˜²æ­¢ 90% ä»¥ä¸Šçš„æƒé™ç»•è¿‡æ”»å‡»
- âœ… æš´åŠ›ç ´è§£æˆåŠŸç‡é™è‡³æ¥è¿‘ 0
- âœ… 100% æ“ä½œå¯è¿½æº¯

### è¿è¥æ•ˆç‡
- âœ… æ‰¹é‡æ“ä½œæ•ˆç‡æå‡ 10 å€
- âœ… æ•°æ®åˆ†ææ—¶é—´å‡å°‘ 80%
- âœ… å¼‚å¸¸æ£€æµ‹è‡ªåŠ¨åŒ–

### ç”¨æˆ·ä½“éªŒ
- âœ… ç»­è´¹ç‡æå‡ 30%+
- âœ… ç”¨æˆ·æŠ•è¯‰å‡å°‘ 50%+
- âœ… å¹³å‡å“åº”æ—¶é—´ < 200ms

### ç³»ç»Ÿæ€§èƒ½
- âœ… æ•°æ®åº“è´Ÿè½½é™ä½ 60%
- âœ… API å“åº”é€Ÿåº¦æå‡ 5 å€
- âœ… æ”¯æŒ 10 å€ç”¨æˆ·å¢é•¿

---

## ğŸš€ åç»­è§„åˆ’

### ç¬¬äºŒé˜¶æ®µï¼ˆ1ä¸ªæœˆåï¼‰
1. **ç§»åŠ¨ç«¯é€‚é…** - PWA æ”¯æŒ
2. **å¤šè¯­è¨€æ”¯æŒ** - å›½é™…åŒ–
3. **æ”¯ä»˜é›†æˆ** - æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜
4. **é‚®ä»¶ç³»ç»Ÿ** - è‡ªåŠ¨å‘é€é€šçŸ¥é‚®ä»¶
5. **æ¨èç³»ç»Ÿ** - æ ¹æ®ç”¨æˆ·è¡Œä¸ºæ¨èäº§å“

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ3ä¸ªæœˆåï¼‰
1. **æ•°æ®å¤§å±** - å¯è§†åŒ–è¿è¥æ•°æ®
2. **API å¼€æ”¾** - ç¬¬ä¸‰æ–¹é›†æˆ
3. **ç™½æ ‡ç³»ç»Ÿ** - æ”¯æŒå¤šå“ç‰Œ
4. **AI å®¢æœ** - æ™ºèƒ½é—®ç­”
5. **ä¼šå‘˜ç¤¾åŒº** - ç”¨æˆ·äº¤æµå¹³å°

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¶é—´**: 2026-01-04
**è´Ÿè´£äºº**: Claude Code
**å®¡æ ¸çŠ¶æ€**: å¾…å®æ–½
