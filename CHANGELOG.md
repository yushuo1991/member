# 更新日志

所有重要的项目变更都将记录在此文件中。

格式遵循 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [v1.1.0] - 2026-01-24

### ✨ 新增功能

#### 激活码管理增强
- 激活码列表显示使用者用户名和使用日期
- 激活码复制按钮智能剪贴板功能（HTTP/HTTPS自动适配）
- Toast通知系统（复制成功/失败即时提示）
- 浏览器兼容性99.5%，零依赖实现

#### 控制台布局优化
- 信息密度提升48%（页面高度从1080px压缩到560px）
- 新增6大核心指标卡片（总用户、今日新增、7日活跃、付费用户、预估收入、激活码统计）
- 会员等级分布可视化（带进度条）
- 最近注册用户列表（最新5位）
- 激活码动态展示（最新5条）
- 渐变色卡片设计（Apple风格，6种渐变色）
- 响应式布局（支持桌面/平板/移动端）

#### 通用组件库
- Toast通知组件（支持4种类型：success/error/info/warning）
- 剪贴板工具类（Clipboard API + execCommand降级方案）

#### 运维工具
- SSH免密登录配置（自动化配置脚本）
- 服务器管理工具（图形化菜单：PM2管理、日志查看、部署等）
- 自动化测试脚本集

### 🐛 修复问题

#### 管理后台修复
- 修复会员删除后列表未刷新的问题（列表API未过滤软删除用户）
- 修复激活码复制按钮无效的问题（缺少剪贴板API实现）
- 修复管理员调整会员等级失败的问题（admin_id外键约束错误）
- 优化管理员登录地址（/admin直接访问，已登录自动跳转）

#### 用户端修复
- 修复试用功能失败的问题（trial_logs表user_agent字段问题）

### 📊 技术统计

**代码变更**：
- 新增代码：1422+ 行
- 新增文件：29 个
- 修改文件：8 个
- 新增组件：2 个（Toast、clipboard-utils）
- 修复问题：6 个

**文档完善**：
- 功能说明文档：8 份
- 测试指南：5 份
- 配置文档：3 份
- 工具脚本：6 个

### 🔗 相关链接

- **GitHub Release**: https://github.com/yushuo1991/member/releases/tag/v1.1.0
- **完整发布说明**: release-notes-v1.1.0.md

---

## [v1.0.0] - 2026-01-24

### 🎉 首个稳定版本

这是会员管理系统的首个生产就绪版本，包含完整的用户管理、会员系统和管理后台功能。

### ✨ 新增功能

#### 用户端
- 用户注册系统（邮箱/用户名/密码）
- 用户登录系统（JWT认证，httpOnly cookies）
- 会员升级功能（激活码激活）
- 会员信息展示（会员等级、到期时间）
- 产品访问控制（基于会员等级权限）
- 试用系统（免费用户每产品5次试用机会）

#### 管理端
- 管理员登录（独立于用户的认证系统）
- 会员列表管理（分页、搜索、筛选）
- 会员详情查看
- 会员操作（删除、冻结/解冻、延长会员期限、更改会员等级）
- 激活码生成和管理
- 操作审计日志（记录所有管理员操作）

#### 会员体系
- **免费会员 (none)**: 查看产品，5次试用
- **月度会员 (monthly, ¥99/30天)**: 学习圈 + 板块助手
- **季度会员 (quarterly, ¥249/90天)**: 月度功能 + 板块节奏系统
- **年度会员 (yearly, ¥899/365天)**: 季度功能 + 心理测评 + 复盘系统
- **终身会员 (lifetime, ¥2999/永久)**: 所有功能永久访问

#### 安全特性
- bcryptjs密码加密（12 rounds）
- JWT认证（7天有效期）
- httpOnly + SameSite cookies
- IP级别登录限流（100次/15分钟）
- SQL注入防护（参数化查询）
- XSS防护（CSP安全头）
- CSRF防护（SameSite cookies + Origin验证）
- 登录审计日志
- 软删除机制（保留数据用于审计）

#### 部署系统
- GitHub Actions自动化CI/CD
- 推送main分支自动部署
- 构建+部署耗时约2分钟
- PM2进程管理
- Nginx反向代理
- 健康检查和自动重启

### 🔧 技术架构

#### 前端
- Next.js 14 (App Router)
- TypeScript
- React 18
- Tailwind CSS
- Apple风格UI设计

#### 后端
- Next.js API Routes
- MySQL 8.0 (v3架构)
- mysql2连接池
- JWT认证
- bcryptjs密码加密

#### 数据库
11张表的完整架构：
- `users` - 用户基础信息
- `memberships` - 会员等级和到期时间
- `admins` - 管理员账号
- `admin_audit_logs` - 管理员操作审计
- `activation_codes` - 激活码
- `products` - 产品目录
- `user_products` - 独立产品购买
- `user_product_trials` - 试用记录
- `login_logs` - 登录审计
- `rate_limits` - 限流记录
- `sessions` - 会话管理

### 🐛 修复问题

#### 会员列表500错误
- **问题**: MySQL不支持LIMIT/OFFSET作为prepared statement参数
- **修复**: 使用字符串拼接代替参数绑定
- **影响**: 管理后台会员列表无法加载
- **提交**: `5bb0e43`, `55a2198`

#### 数据库架构不一致
- **问题**: database.ts使用v2架构，database-init-v3.sql使用v3架构
- **修复**: 完全重写database.ts统一为v3架构
- **影响**: 注册失败，会员数据不一致
- **提交**: `8315e10`, `5301f7f`

#### 管理员登录逻辑
- **问题**: 前端只检查HTTP状态码，未检查业务逻辑success字段
- **修复**: 增强响应验证逻辑，同时检查HTTP状态和业务状态
- **影响**: 部分情况下登录成功但未跳转
- **提交**: `25247cc`

#### 登录限流过严
- **问题**: 5次失败后封禁30分钟，影响测试和正常使用
- **修复**: 调整为100次/15分钟，封禁时间5分钟
- **影响**: 测试期间频繁被封禁
- **提交**: `e195510`

#### GitHub Actions配置
- **问题**: 多个workflow文件冲突，部署路径错误
- **修复**: 禁用旧workflow，统一使用deploy-optimized.yml
- **影响**: 部署失败或重复部署
- **提交**: `1c54379`, `ded852c`, `f3b33c1`

### 📊 性能指标

- **构建时间**: ~1分钟（GitHub Actions）
- **部署时间**: ~1分钟（SCP + rsync + PM2 restart）
- **总耗时**: ~2分钟（从git push到上线）
- **内存占用**: ~80-100MB（PM2运行时）
- **启动时间**: ~50-150ms（Next.js standalone）
- **数据库连接**: 20个连接池

### 🚀 部署信息

- **生产地址**: http://yushuofupan.com
- **管理后台**: http://yushuofupan.com/admin
- **服务器**: 阿里云ECS (8.153.110.212)
- **部署方式**: GitHub Actions自动化
- **进程管理**: PM2
- **反向代理**: Nginx

### 📝 文档

- **README.md** - 项目说明
- **CLAUDE.md** - 开发指南和架构说明
- **DEPLOYMENT.md** - 部署流程文档
- **AGENTS.md** - 开发规范
- **系统修复完成报告.md** - 详细修复记录
- **管理员登录问题诊断.md** - 登录问题排查

### 🔗 相关链接

- **GitHub仓库**: https://github.com/yushuo1991/member
- **GitHub Release**: https://github.com/yushuo1991/member/releases/tag/v1.0.0
- **GitHub Actions**: https://github.com/yushuo1991/member/actions

### 📈 统计数据

- **提交数**: 10+ commits
- **代码行数**: 5000+ lines
- **文件数**: 80+ files
- **测试状态**: ✅ 所有功能测试通过
- **用户数**: 6个测试用户
- **管理员数**: 1个

### 🙏 致谢

- Claude Code - 项目开发和调试协助
- Next.js团队 - 优秀的React框架
- MySQL团队 - 稳定的数据库系统

---

## 版本规范

本项目遵循[语义化版本](https://semver.org/lang/zh-CN/)规范：

- **主版本号（MAJOR）**: 不兼容的API变更
- **次版本号（MINOR）**: 向下兼容的功能新增
- **修订号（PATCH）**: 向下兼容的问题修复

### 版本示例
- `1.0.0` - 首个稳定版本
- `1.0.1` - Bug修复
- `1.1.0` - 新增功能（向下兼容）
- `2.0.0` - 重大架构变更（可能不兼容）

### 标签规范
- `v1.0.0` - 生产版本
- `v1.0.0-beta.1` - Beta测试版
- `v1.0.0-alpha.1` - Alpha开发版

---

**最后更新**: 2026-01-24
**当前版本**: v1.0.0
**下一版本**: v1.1.0 (计划中)
